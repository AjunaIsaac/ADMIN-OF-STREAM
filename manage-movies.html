<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Movies - Admin Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- PocketBase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/pocketbase@latest/dist/pocketbase.umd.js"></script>
    <style>
        :root {
            --primary-bg: #0A0F2A; --card-bg: #1C2141; --accent-color: #DFFF00;
            --text-primary: #FFFFFF; --text-secondary: #a9a9b3; --input-bg: #0A0F2A;
            --success-color: #27ae60; --danger-color: #e74c3c;
        }
        body { background-color: var(--primary-bg); color: var(--text-primary); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; margin: 0; display: flex; min-height: 100vh; }
        
        #mainMenu { width: 250px; flex-shrink: 0; background-color: #111533; padding-top: 20px; }
        #mainMenu a { display: block; padding: 15px 20px; color: var(--text-secondary); text-decoration: none; display: flex; align-items: center; gap: 10px; }
        #mainMenu a:hover, #mainMenu a.active { background-color: var(--card-bg); color: var(--accent-color); }
        
        .main-content { flex-grow: 1; padding: 2rem; overflow-y: auto; }
        
        /* Views */
        #searchView, #detailsView { background-color: var(--card-bg); padding: 2rem; border-radius: 15px; max-width: 900px; margin: 0 auto; }
        
        h2 { color: var(--accent-color); margin-top: 0; }
        
        /* Form Elements */
        .form-group { margin-bottom: 1.5rem; }
        label { display: block; margin-bottom: 8px; color: var(--text-secondary); }
        input, textarea, select { width: 100%; background-color: var(--input-bg); border: 1px solid #33395b; color: white; padding: 12px; border-radius: 8px; box-sizing: border-box; }
        
        /* Buttons */
        .btn { width: 100%; padding: 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 1rem; }
        .btn-primary { background: linear-gradient(90deg, #FF416C, #FFDE00); color: white; }
        .btn-secondary { background: #33395b; color: white; }
        .btn-cancel { background: #555; color: white; }
        
        /* Search Results */
        #searchResultsContainer { margin-top: 20px; display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        .movie-card { background-color: var(--primary-bg); border-radius: 8px; overflow: hidden; cursor: pointer; transition: transform 0.2s; border: 1px solid #33395b; }
        .movie-card:hover { transform: translateY(-5px); border-color: var(--accent-color); }
        .movie-card img { width: 100%; height: 300px; object-fit: cover; }
        .movie-card h3 { padding: 10px; font-size: 0.9rem; margin: 0; text-align: center; }

        /* Movie Details Header */
        #detailsHeader { display: flex; gap: 20px; margin-bottom: 20px; border-bottom: 1px solid #33395b; padding-bottom: 20px; }
        #moviePoster { width: 120px; border-radius: 8px; }
        
        /* Checkboxes */
        .checkbox-group { display: flex; flex-wrap: wrap; gap: 10px; max-height: 200px; overflow-y: auto; background: var(--input-bg); padding: 10px; border-radius: 8px; }
        .checkbox-label { display: flex; align-items: center; gap: 8px; background: #161b33; padding: 5px 10px; border-radius: 4px; border: 1px solid #33395b; font-size: 0.9rem; width: auto; cursor: pointer; }
        .checkbox-label:hover { border-color: var(--accent-color); }
        .checkbox-label input { width: auto; margin: 0; }

        .message { padding: 15px; border-radius: 8px; margin-top: 1rem; display: none; text-align: center; }
        .message.success { background-color: var(--success-color); }
        .message.error { background-color: var(--danger-color); }
    </style>
</head>
<body>

    <nav id="mainMenu">
            <div class="menu-header">Admin Menu</div>
            <a href="index.html" class="active"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
            <hr style="border-color: #333; margin: 10px 0;">
            <a href="manage-movies.html"><i class="fas fa-film"></i> Manage Movies</a>
            <a href="manage-series.html"><i class="fas fa-tv"></i> Manage Series</a>
            <a href="manage-banners.html"><i class="fas fa-images"></i> Manage Banners</a>
            <a href="manage-notifications.html"><i class="fas fa-paper-plane"></i> Notifications</a>
            <a href="manage-users.html"><i class="fas fa-users-cog"></i> User Management</a>
            <a href="all-content.html"><i class="fas fa-list-ul"></i> Browse All Content</a>
        </nav>

    <div class="main-content">
        
        <!-- VIEW 1: SEARCH TMDB (Default) -->
        <div id="searchView">
            <h2>Add New Movie</h2>
            <div class="form-group">
                <label>Search TMDB for a Movie</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="searchQuery" placeholder="e.g. Gladiator II">
                    <button id="searchTmdbBtn" class="btn btn-secondary" style="width: auto;">Search</button>
                </div>
            </div>
            <div id="searchResultsContainer"></div>
        </div>

        <!-- VIEW 2: EDIT DETAILS (Hidden by default) -->
        <div id="detailsView" style="display: none;">
            <div id="detailsHeader">
                <img id="displayPoster" src="" alt="Poster">
                <div>
                    <h2 id="displayTitle">Movie Title</h2>
                    <p id="displayOverview" style="color: var(--text-secondary); font-size: 0.9rem;"></p>
                </div>
            </div>

            <form id="movieForm">
                <!-- Hidden Fields to store data -->
                <input type="hidden" id="recordId"> <!-- PocketBase ID -->
                <input type="hidden" id="tmdbId">
                <input type="hidden" id="posterUrl">
                <input type="hidden" id="backdropUrl">
                <input type="hidden" id="releaseDate">

                <div class="form-group">
                    <label>VJ Name (Required)</label>
                    <div id="vjContainer" class="checkbox-group"></div>
                </div>

                <div class="form-group">
                    <label>Video URL</label>
                    <input type="text" id="videoUrl" placeholder="https://..." required>
                </div>

                <div class="form-group">
                    <label>Release Year</label>
                    <input type="number" id="movieYear">
                </div>

                <div class="form-group">
                    <label>Genres (Select multiple)</label>
                    <div id="genreContainer" class="checkbox-group"></div>
                </div>

                <div style="display: flex; gap: 15px;">
                    <button type="submit" class="btn btn-primary" id="saveBtn">Save to Database</button>
                    <button type="button" class="btn btn-cancel" id="cancelBtn">Cancel</button>
                </div>
            </form>
            <div id="formMessage" class="message"></div>
        </div>

    </div>
<script>
    // 1. Initialize PocketBase
    const pb = new PocketBase('https://db.jmovies.site');
    pb.autoCancellation(false);
    const TMDB_API_KEY = "f7a3b097ba7a990fd0c8ef3147646fb5"; 

    // 2. DATA LISTS
    const VJ_LIST = ["VJ JUNIOR", "VJ TONNY", "VJ PAX", "VJ EMMY", "VJ LIGHT","VJ RYAN","VJ JOE", "HEAVY Q", "VJ MK","VJ HAM", "VJ MARK", "VJ SHIELD", "VJ ISMA K","VJ MOSCO", "ILLESS", "VJ BONNY", "VJ NEIL", "VJ JOVAN", "VJ TOM", "VJ SHAO K", "VJ JINGO", "VJ ICE P", "VJ KEVO", "VJ KEVIN", "VJ KIN", "VJ KRISS SWEET", "VJ HD", "VJ DAN DE", "VJ SAMMY", "VJ IVO", "VJ LITTLE T", "VJ LASH", "VJ MOX", "VJ MUBA", "VJ EDDY", "VJ KAM", "VJ LANCE", "VJ KS", "VJ ULIO", "VJ AARON", "VJ CABS", "VJ BANKS", "VJ JIMMY", "VJ BAROS", "VJ SOUL", "VJ SON", "VJ KIMULI", "VJ FREDY", "VJ JUMPERS", "VJ ASHIM", "VJ PAULETA", "VJ MARTIN K", "VJ HENRICO", "VJ MUSA", "VJ UNCLE T", "VJ WAZA", "VJ RONAGE"];
    const GENRE_LIST = ["ACTION", "HORROR", "ADVENTURE", "LOVE STORY", "COMEDY", "CRIME", "FAMILY", "SCI FI", "ROMANCE", "KUNGU FU", "DRAMA", "SPORT", "THRILLER", "ANIMATION", "DOCUMENTARY", "FANTASY", "HISTORY", "MYSTERY", "WAR"];
    
    // ✅ NEW: Special Categories for Home Page Sections
    const SPECIAL_CATEGORIES = [
        { label: "Trending This Week", value: "trending" },
        { label: "High School", value: "high-school" },
        { label: "Latest on Jmovies", value: "latest_on_jmovies" }
    ];

    // DOM Elements
    const searchView = document.getElementById('searchView');
    const detailsView = document.getElementById('detailsView');
    const searchResults = document.getElementById('searchResultsContainer');
    const msgEl = document.getElementById('formMessage');
    const saveBtn = document.getElementById('saveBtn');

    // --- HELPER: Create Checkboxes ---
    function createCheckboxes(list, containerId, name, isObject = false) {
        const container = document.getElementById(containerId);
        // If container doesn't exist (like categories in old HTML), create it dynamically
        if (!container) return; 
        
        container.innerHTML = '';
        list.forEach(item => {
            const label = document.createElement('label');
            label.className = 'checkbox-label';
            const value = isObject ? item.value : item;
            const text = isObject ? item.label : item;
            
            label.innerHTML = `<input type="checkbox" name="${name}" value="${value}"> ${text}`;
            container.appendChild(label);
        });
    }

    // --- RUN SETUP ---
    document.addEventListener('DOMContentLoaded', async () => {
        // Setup lists
        createCheckboxes(VJ_LIST, 'vjContainer', 'vjs');
        createCheckboxes(GENRE_LIST, 'genreContainer', 'genres');
        
        // ✅ Inject Category Container if missing in HTML
        let catContainer = document.getElementById('categoryContainer');
        if (!catContainer) {
            const formGroup = document.createElement('div');
            formGroup.className = 'form-group';
            formGroup.innerHTML = `<label>Special Categories (Home Page)</label><div id="categoryContainer" class="checkbox-group"></div>`;
            // Insert after Genres
            document.getElementById('genreContainer').parentElement.after(formGroup);
            catContainer = document.getElementById('categoryContainer');
        }
        createCheckboxes(SPECIAL_CATEGORIES, 'categoryContainer', 'type', true);

        // Check Edit Mode
        const urlParams = new URLSearchParams(window.location.search);
        const editId = urlParams.get('id');
        if (editId) loadMovieForEditing(editId);
    });

    // --- LOGIC: SEARCH TMDB ---
    document.getElementById('searchTmdbBtn').addEventListener('click', async () => {
        const query = document.getElementById('searchQuery').value;
        if (!query) return;
        searchResults.innerHTML = '<p style="color:white">Searching...</p>';
        try {
            const res = await fetch(`https://api.themoviedb.org/3/search/movie?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(query)}`);
            const data = await res.json();
            searchResults.innerHTML = '';
            if (!data.results?.length) { searchResults.innerHTML = '<p>No results.</p>'; return; }
            
            data.results.forEach(movie => {
                const card = document.createElement('div');
                card.className = 'movie-card';
                card.innerHTML = `<img src="${movie.poster_path ? 'https://image.tmdb.org/t/p/w200'+movie.poster_path : 'https://placehold.co/200'}" ><h3>${movie.title}</h3>`;
                card.addEventListener('click', () => selectMovieFromSearch(movie));
                searchResults.appendChild(card);
            });
        } catch (err) { searchResults.innerHTML = `<p style="color:red">${err.message}</p>`; }
    });

    async function selectMovieFromSearch(movie) {
        const res = await fetch(`https://api.themoviedb.org/3/movie/${movie.id}?api_key=${TMDB_API_KEY}`);
        const fullData = await res.json();

        document.getElementById('recordId').value = ""; 
        saveBtn.innerText = "Save to Database";

        document.getElementById('displayTitle').textContent = fullData.title;
        document.getElementById('displayOverview').textContent = fullData.overview;
        document.getElementById('displayPoster').src = fullData.poster_path ? `https://image.tmdb.org/t/p/w200${fullData.poster_path}` : '';
        
        document.getElementById('tmdbId').value = fullData.id;
        document.getElementById('posterUrl').value = fullData.poster_path ? `https://image.tmdb.org/t/p/w500${fullData.poster_path}` : '';
        document.getElementById('backdropUrl').value = fullData.backdrop_path ? `https://image.tmdb.org/t/p/original${fullData.backdrop_path}` : '';
        document.getElementById('releaseDate').value = fullData.release_date;
        document.getElementById('movieYear').value = fullData.release_date ? fullData.release_date.split('-')[0] : '';

        // Auto-select Genres
        document.querySelectorAll('input[name="genres"]').forEach(cb => cb.checked = false);
        if (fullData.genres) {
            fullData.genres.forEach(g => {
                const tmdbGenre = g.name.toUpperCase();
                document.querySelectorAll('input[name="genres"]').forEach(cb => {
                    const myGenre = cb.value.toUpperCase();
                    if (tmdbGenre.includes(myGenre) || (tmdbGenre.includes("SCI") && myGenre === "SCI FI")) {
                        cb.checked = true;
                    }
                });
            });
        }

        searchView.style.display = 'none';
        detailsView.style.display = 'block';
    }

    // --- LOAD EDITING ---
    async function loadMovieForEditing(id) {
        try {
            const record = await pb.collection('media').getOne(id);
            document.getElementById('recordId').value = record.id;
            document.getElementById('displayTitle').textContent = record.title;
            document.getElementById('displayOverview').textContent = record.description;
            document.getElementById('displayPoster').src = record.poster || '';
            document.getElementById('videoUrl').value = record.videoUrl || '';
            document.getElementById('tmdbId').value = record.tmdbId || '';
            document.getElementById('posterUrl').value = record.poster || '';
            document.getElementById('backdropUrl').value = record.backdrop || '';
            document.getElementById('releaseDate').value = record.releaseDate || '';
            if(record.releaseDate) document.getElementById('movieYear').value = record.releaseDate.split('-')[0];

            // Checkboxes
            const checkBoxes = (name, values) => {
                if(values && Array.isArray(values)) values.forEach(v => {
                    const cb = document.querySelector(`input[name="${name}"][value="${v}"]`);
                    if(cb) cb.checked = true;
                });
            };
            checkBoxes('vjs', record.vjs);
            checkBoxes('genres', record.genres);
            checkBoxes('type', record.type); // ✅ Load Special Categories

            searchView.style.display = 'none';
            detailsView.style.display = 'block';
            saveBtn.innerText = "Update Movie";
        } catch (err) { alert(err.message); window.location.href='all-content.html'; }
    }

    // --- SAVE ---
    document.getElementById('movieForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        saveBtn.disabled = true; saveBtn.innerText = "Processing...";

        const getChecked = (name) => Array.from(document.querySelectorAll(`input[name="${name}"]:checked`)).map(cb => cb.value);

        const data = {
            title: document.getElementById('displayTitle').textContent,
            tmdbId: document.getElementById('tmdbId').value,
            description: document.getElementById('displayOverview').textContent,
            videoUrl: document.getElementById('videoUrl').value,
            poster: document.getElementById('posterUrl').value,
            backdrop: document.getElementById('backdropUrl').value,
            releaseDate: document.getElementById('releaseDate').value,
            vjs: getChecked('vjs'),
            genres: getChecked('genres'),
            type: getChecked('type'), // ✅ Save Special Categories
            contentType: 'movie'
        };

        try {
            const id = document.getElementById('recordId').value;
            if (id) await pb.collection('media').update(id, data);
            else await pb.collection('media').create(data);
            
            msgEl.textContent = "Success!"; msgEl.style.display = 'block';
            setTimeout(() => window.location.href='all-content.html', 1500);
        } catch (err) {
            msgEl.textContent = err.message; msgEl.style.display = 'block';
            saveBtn.disabled = false;
        }
    });
    document.getElementById('cancelBtn').addEventListener('click', () => window.location.href='all-content.html');
</script>
</body>
</html>