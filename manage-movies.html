<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- Critical for Mobile -->
    <title>Manage Movies - Admin Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/pocketbase@latest/dist/pocketbase.umd.js"></script>
    <style>
        :root {
            --primary-bg: #0A0F2A; --card-bg: #1C2141; --accent-color: #DFFF00;
            --text-primary: #FFFFFF; --text-secondary: #a9a9b3; --input-bg: #0E1225;
            --success-color: #27ae60; --danger-color: #e74c3c;
            --border-color: #33395b;
        }
        body { background-color: var(--primary-bg); color: var(--text-primary); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; display: flex; min-height: 100vh; }
        
        /* --- DESKTOP SIDEBAR --- */
        #mainMenu { width: 250px; flex-shrink: 0; background-color: #111533; padding-top: 20px; border-right: 1px solid var(--border-color); }
        #mainMenu a { display: block; padding: 15px 20px; color: var(--text-secondary); text-decoration: none; display: flex; align-items: center; gap: 10px; transition: 0.2s; }
        #mainMenu a:hover, #mainMenu a.active { background-color: var(--card-bg); color: var(--accent-color); border-left: 4px solid var(--accent-color); }
        
        .main-content { flex-grow: 1; padding: 2rem; overflow-y: auto; width: 100%; box-sizing: border-box; }
        
        /* --- CARDS & CONTAINERS --- */
        #searchView, #detailsView { background-color: var(--card-bg); padding: 2rem; border-radius: 12px; max-width: 900px; margin: 0 auto; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        
        h2 { color: var(--accent-color); margin-top: 0; font-size: 1.5rem; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 20px; }
        
        /* --- FORMS --- */
        .form-group { margin-bottom: 1.5rem; }
        label { display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500; font-size: 0.9rem; }
        input, textarea, select { width: 100%; background-color: var(--input-bg); border: 1px solid var(--border-color); color: white; padding: 12px; border-radius: 8px; box-sizing: border-box; font-size: 16px; /* Prevents zoom on mobile */ }
        input:focus { border-color: var(--accent-color); outline: none; }
        
        /* --- BUTTONS --- */
        .btn { width: 100%; padding: 14px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 1rem; transition: transform 0.1s; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: linear-gradient(90deg, #FF416C, #FFDE00); color: #000; }
        .btn-secondary { background: var(--input-bg); color: white; border: 1px solid var(--border-color); }
        .btn-cancel { background: #444; color: white; }
        
        /* --- SEARCH GRID --- */
        #searchResultsContainer { margin-top: 20px; display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; }
        .movie-card { background-color: var(--input-bg); border-radius: 8px; overflow: hidden; cursor: pointer; border: 1px solid var(--border-color); position: relative; }
        .movie-card:hover { border-color: var(--accent-color); }
        .movie-card img { width: 100%; aspect-ratio: 2/3; object-fit: cover; }
        .movie-card h3 { padding: 10px; font-size: 0.85rem; margin: 0; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* --- DETAILS VIEW --- */
        #detailsHeader { display: flex; gap: 20px; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 20px; }
        #displayPoster { width: 100px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        
        /* --- CHECKBOXES --- */
        .checkbox-group { display: flex; flex-wrap: wrap; gap: 8px; max-height: 200px; overflow-y: auto; background: var(--input-bg); padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); }
        .checkbox-label { display: flex; align-items: center; gap: 8px; background: #1a2035; padding: 6px 12px; border-radius: 50px; border: 1px solid var(--border-color); font-size: 0.85rem; cursor: pointer; user-select: none; transition: 0.2s; }
        .checkbox-label:hover { border-color: var(--accent-color); }
        .checkbox-label input { width: auto; margin: 0; accent-color: var(--accent-color); }
        /* Style for checked state logic usually done in JS, but simple CSS active state */
        .checkbox-label:has(input:checked) { background-color: rgba(223, 255, 0, 0.15); border-color: var(--accent-color); color: var(--accent-color); }

        .message { padding: 15px; border-radius: 8px; margin-top: 1rem; display: none; text-align: center; font-weight: bold; }
        .message.success { background-color: rgba(39, 174, 96, 0.2); color: var(--success-color); border: 1px solid var(--success-color); }
        .message.error { background-color: rgba(231, 76, 60, 0.2); color: var(--danger-color); border: 1px solid var(--danger-color); }

        /* --- ðŸ“± MOBILE RESPONSIVENESS --- */
        @media (max-width: 768px) {
            body { flex-direction: column; }
            
            #mainMenu { width: 100%; height: auto; padding: 10px 0; overflow-x: auto; white-space: nowrap; display: flex; border-right: none; border-bottom: 1px solid var(--border-color); }
            #mainMenu a { display: inline-flex; padding: 10px 15px; font-size: 0.9rem; flex-direction: column; gap: 5px; text-align: center; min-width: 60px; }
            #mainMenu i { font-size: 1.2rem; margin-bottom: 2px; }
            
            .main-content { padding: 1rem; }
            
            #searchView, #detailsView { padding: 1.2rem; }
            
            #detailsHeader { flex-direction: column; align-items: center; text-align: center; }
            #displayPoster { width: 140px; }
            
            .btn { padding: 16px; } /* Larger touch target */
            
            #searchResultsContainer { grid-template-columns: repeat(2, 1fr); } /* 2 Columns on Mobile */
        }
    </style>
</head>
<body>

    <nav id="mainMenu">
        <a href="index.html"><i class="fas fa-tachometer-alt"></i> <span>Dashboard</span></a>
        <a href="manage-movies.html" class="active"><i class="fas fa-film"></i> <span>Movies</span></a>
        <a href="manage-series.html"><i class="fas fa-tv"></i> <span>Series</span></a>
        <a href="manage-banners.html"><i class="fas fa-images"></i> <span>Banners</span></a>
        <a href="manage-notifications.html"><i class="fas fa-paper-plane"></i> <span>Notify</span></a>
        <a href="manage-users.html"><i class="fas fa-users-cog"></i> <span>Users</span></a>
        <a href="all-content.html"><i class="fas fa-list-ul"></i> <span>All</span></a>
    </nav>

    <div class="main-content">
        
        <!-- SEARCH VIEW -->
        <div id="searchView">
            <h2>Add New Movie</h2>
            <div class="form-group">
                <label>Search TMDB</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="searchQuery" placeholder="e.g. Gladiator II">
                    <button id="searchTmdbBtn" class="btn btn-secondary" style="width: auto; margin-top:0;">Search</button>
                </div>
            </div>
            <div id="searchResultsContainer"></div>
        </div>

        <!-- DETAILS VIEW -->
        <div id="detailsView" style="display: none;">
            <div id="detailsHeader">
                <img id="displayPoster" src="" alt="Poster">
                <div>
                    <h2 id="displayTitle">Movie Title</h2>
                    <p id="displayOverview" style="color: var(--text-secondary); font-size: 0.85rem; line-height: 1.4;"></p>
                </div>
            </div>

            <form id="movieForm">
                <!-- HIDDEN FIELDS -->
                <input type="hidden" id="recordId"> 
                <input type="hidden" id="tmdb_id">
                <input type="hidden" id="posterUrl">
                <input type="hidden" id="backdropUrl">
                <input type="hidden" id="releaseYear">
                <input type="hidden" id="cleanTitle">

                <div class="form-group">
                    <label>Stream Link (Required)</label>
                    <input type="text" id="stream_link" placeholder="https://..." required>
                </div>
                
                <div class="form-group">
                    <label>VJ Name</label>
                    <div id="vjContainer" class="checkbox-group"></div>
                </div>

                <!-- SEPARATED GENRES -->
                <div class="form-group">
                    <label>Genres <small>(Auto-filled from TMDB)</small></label>
                    <div id="genresContainer" class="checkbox-group"></div>
                </div>

                <!-- SEPARATED TAGS -->
                <div class="form-group">
                    <label>App Tags <small>(Home Page Sections)</small></label>
                    <div id="tagsContainer" class="checkbox-group"></div>
                </div>

                <div style="display: flex; gap: 15px; flex-direction: column-reverse; /* Stack buttons on mobile */">
                    <button type="button" class="btn btn-cancel" id="cancelBtn">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="saveBtn">Save to Database</button>
                </div>
                <!-- Desktop fix for buttons -->
                <style> @media(min-width: 769px) { #movieForm div:last-child { flex-direction: row !important; } } </style>
            </form>
            <div id="formMessage" class="message"></div>
        </div>

    </div>
    <script>
    const pb = new PocketBase('https://db.streamzonemovies.online');
    pb.autoCancellation(false);
    const TMDB_API_KEY = "f7a3b097ba7a990fd0c8ef3147646fb5"; 

    const GENRE_LIST = [
        "ACTION", "ADVENTURE", "ANIMATION", "COMEDY", "CRIME", "DOCUMENTARY", "DRAMA", 
        "FAMILY", "FANTASY", "HISTORY", "HORROR", "KUNGU FU", "LOVE STORY", "MUSIC", 
        "MYSTERY", "ROMANCE", "SCI FI", "SPORT", "THRILLER", "WAR", "WESTERN"
    ];
    
    // Updated TAGS_LIST with all categories
    const TAGS_LIST = [
        "latest_uploads", "recent_movies", "most_liked", "romance", 
        "Latest-Movies", "indian",
        "action-thriller", "scifi-fantasy", "high-school", "animation", "horror", 
        "comedy", "adventure", "send_notification"
    ];

    const VJ_LIST = ["VJ JUNIOR", "VJ TONNY","VJ ARTIK","VJ SHIVO", "VJ PAX", "VJ EMMY", "VJ LIGHT","VJ RYAN","VJ JOE", "HEAVY Q", "VJ MK","VJ HAM", "VJ MARK", "VJ SHIELD", "VJ ISMA K","VJ MOSCO", "ILLESS", "VJ BONNY", "VJ NEIL", "VJ JOVAN", "VJ TOM", "VJ SHAO K", "VJ JINGO", "VJ ICE P", "VJ KEVO", "VJ KEVIN", "VJ KIN", "VJ KRISS SWEET", "VJ HD", "VJ DAN DE", "VJ SAMMY", "VJ IVO", "VJ LITTLE T", "VJ LASH", "VJ MOX", "VJ MUBA", "VJ EDDY", "VJ KAM", "VJ LANCE", "VJ KS", "VJ ULIO", "VJ AARON", "VJ CABS", "VJ BANKS", "VJ JIMMY", "VJ BAROS", "VJ SOUL", "VJ SON", "VJ KIMULI", "VJ FREDY", "VJ JUMPERS", "VJ ASHIM", "VJ PAULETA", "VJ MARTIN K", "VJ HENRICO", "VJ MUSA", "VJ UNCLE T", "VJ WAZA", "VJ RONAGE"];

    const searchView = document.getElementById('searchView');
    const detailsView = document.getElementById('detailsView');
    const searchResults = document.getElementById('searchResultsContainer');
    const msgEl = document.getElementById('formMessage');
    const saveBtn = document.getElementById('saveBtn');

    function createCheckboxes(list, containerId, name) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        list.sort().forEach(item => {
            const label = document.createElement('label');
            label.className = 'checkbox-label';
            const displayText = item.replace(/_/g, ' ').replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            label.innerHTML = `<input type="checkbox" name="${name}" value="${item}"> ${displayText}`;
            container.appendChild(label);
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        createCheckboxes(VJ_LIST, 'vjContainer', 'vjs');
        createCheckboxes(GENRE_LIST, 'genresContainer', 'genres');
        createCheckboxes(TAGS_LIST, 'tagsContainer', 'tags');

        const urlParams = new URLSearchParams(window.location.search);
        const editId = urlParams.get('id');
        if (editId) loadMovieForEditing(editId);
    });

    document.getElementById('searchTmdbBtn').addEventListener('click', async () => {
        const query = document.getElementById('searchQuery').value;
        if (!query) return;
        searchResults.innerHTML = '<p style="text-align:center; color:#888;">Searching...</p>';
        try {
            const res = await fetch(`https://api.themoviedb.org/3/search/movie?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(query)}`);
            const data = await res.json();
            searchResults.innerHTML = '';
            if (!data.results?.length) { searchResults.innerHTML = '<p>No results.</p>'; return; }
            data.results.forEach(movie => {
                const card = document.createElement('div');
                card.className = 'movie-card';
                const year = movie.release_date ? movie.release_date.split('-')[0] : '';
                card.innerHTML = `<img src="${movie.poster_path ? 'https://image.tmdb.org/t/p/w200'+movie.poster_path : 'https://placehold.co/200'}" ><h3>${movie.title} (${year})</h3>`;
                card.addEventListener('click', () => selectMovieFromSearch(movie));
                searchResults.appendChild(card);
            });
        } catch (err) { searchResults.innerHTML = `<p style="color:red">${err.message}</p>`; }
    });

    async function selectMovieFromSearch(movie) {
        const res = await fetch(`https://api.themoviedb.org/3/movie/${movie.id}?api_key=${TMDB_API_KEY}`);
        const fullData = await res.json();

        document.getElementById('recordId').value = ""; 
        saveBtn.innerText = "Save to Database";

        let cleanYear = "";
        if (fullData.release_date) {
            cleanYear = fullData.release_date.split('-')[0];
        }
        document.getElementById('releaseYear').value = cleanYear;
        document.getElementById('cleanTitle').value = fullData.title; 
        document.getElementById('displayTitle').textContent = fullData.title + (cleanYear ? ` (${cleanYear})` : "");

        document.getElementById('displayOverview').textContent = fullData.overview;
        document.getElementById('displayPoster').src = fullData.poster_path ? `https://image.tmdb.org/t/p/w200${fullData.poster_path}` : '';
        document.getElementById('tmdb_id').value = fullData.id;
        document.getElementById('posterUrl').value = fullData.poster_path ? `https://image.tmdb.org/t/p/w500${fullData.poster_path}` : '';
        document.getElementById('backdropUrl').value = fullData.backdrop_path ? `https://image.tmdb.org/t/p/original${fullData.backdrop_path}` : '';

        document.querySelectorAll('input[name="genres"]').forEach(cb => cb.checked = false);
        document.querySelectorAll('input[name="tags"]').forEach(cb => cb.checked = false);

        if (fullData.genres) {
            fullData.genres.forEach(g => {
                const tmdbGenre = g.name.toUpperCase();
                const mappedGenre = tmdbGenre === 'SCIENCE FICTION' ? 'SCI FI' : tmdbGenre;
                if(GENRE_LIST.includes(mappedGenre)) {
                    const cb = document.querySelector(`input[name="genres"][value="${mappedGenre}"]`);
                    if(cb) cb.checked = true;
                }
            });
        }
        
        const latestCb = document.querySelector('input[name="tags"][value="latest_uploads"]');
        if(latestCb) latestCb.checked = true;

        searchView.style.display = 'none';
        detailsView.style.display = 'block';
    }

    async function loadMovieForEditing(id) {
        try {
            const record = await pb.collection('media').getOne(id);
            document.getElementById('recordId').value = record.id;
            
            document.getElementById('cleanTitle').value = record.title;
            document.getElementById('displayTitle').textContent = record.title;
            document.getElementById('displayOverview').textContent = record.description;
            document.getElementById('displayPoster').src = record.poster || '';
            document.getElementById('stream_link').value = record.stream_link || '';
            document.getElementById('tmdb_id').value = record.tmdb_id || '';
            document.getElementById('posterUrl').value = record.poster || '';
            document.getElementById('backdropUrl').value = record.backdrop || '';
            document.getElementById('releaseYear').value = record.year || '';

            const checkBoxes = (name, values) => {
                if(values && Array.isArray(values)) values.forEach(v => {
                    const cb = document.querySelector(`input[name="${name}"][value="${v}"]`);
                    if(cb) cb.checked = true;
                });
            };
            checkBoxes('vjs', record.vjs);
            checkBoxes('genres', record.genres); 
            checkBoxes('tags', record.tags); 

            searchView.style.display = 'none';
            detailsView.style.display = 'block';
            saveBtn.innerText = "Update Movie";
        } catch (err) { alert(err.message); window.location.href='all-content.html'; }
    }

    document.getElementById('movieForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        saveBtn.disabled = true; saveBtn.innerText = "Checking duplicates...";
        msgEl.style.display = 'none';

        const getChecked = (name) => Array.from(document.querySelectorAll(`input[name="${name}"]:checked`)).map(cb => cb.value);

        const data = {
            title: document.getElementById('cleanTitle').value,
            tmdb_id: document.getElementById('tmdb_id').value,
            description: document.getElementById('displayOverview').textContent,
            stream_link: document.getElementById('stream_link').value,
            poster: document.getElementById('posterUrl').value,
            backdrop: document.getElementById('backdropUrl').value,
            year: document.getElementById('releaseYear').value, 
            vjs: getChecked('vjs'),
            genres: getChecked('genres'),
            tags: getChecked('tags'), 
            contentType: 'movie'
        };

        const currentId = document.getElementById('recordId').value;

        try {
            // ðŸ›‘ DUPLICATE CHECK START
            if (data.tmdb_id) {
                // 1. Find all records with this TMDB ID
                const existingRecords = await pb.collection('media').getFullList({
                    filter: `tmdb_id = "${data.tmdb_id}"`
                });

                // 2. Helper to compare VJ arrays (ignores order: [A,B] == [B,A])
                const isSameVjs = (arr1, arr2) => {
                    const a = [...(arr1 || [])].sort();
                    const b = [...(arr2 || [])].sort();
                    return JSON.stringify(a) === JSON.stringify(b);
                };

                // 3. Check for match
                const duplicate = existingRecords.find(r => {
                    // If editing, skip our own record
                    if (currentId && r.id === currentId) return false;
                    // Check if VJs match
                    return isSameVjs(r.vjs, data.vjs);
                });

                if (duplicate) {
                    throw new Error(`DUPLICATE FOUND: This movie already exists with these exact VJs.`);
                }
            }
            // ðŸ›‘ DUPLICATE CHECK END

            saveBtn.innerText = "Processing...";

            if (currentId) {
                await pb.collection('media').update(currentId, data);
            } else {
                await pb.collection('media').create(data);
            }
            
            msgEl.textContent = "Success! Movie saved correctly.";
            msgEl.className = "message success";
            msgEl.style.display = 'block';
            setTimeout(() => window.location.href='/manage-movies.html', 1500);

        } catch (err) {
            msgEl.textContent = `Error: ${err.message}`;
            msgEl.className = "message error";
            msgEl.style.display = 'block';
            saveBtn.disabled = false;
            saveBtn.innerText = currentId ? "Update Movie" : "Save to Database";
        }
    });

    document.getElementById('cancelBtn').addEventListener('click', () => {
        const id = document.getElementById('recordId').value;
        if(id) {
            window.location.href='/manage-movies.html';
        } else {
            detailsView.style.display = 'none';
            searchView.style.display = 'block';
            document.getElementById('movieForm').reset();
        }
    });
</script>
</body>
</html>
