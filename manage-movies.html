<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Movies - Admin Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/pocketbase@latest/dist/pocketbase.umd.js"></script>
    <style>
        :root {
            --primary-bg: #0A0F2A; --card-bg: #1C2141; --accent-color: #DFFF00;
            --text-primary: #FFFFFF; --text-secondary: #a9a9b3; --input-bg: #0A0F2A;
            --success-color: #27ae60; --danger-color: #e74c3c;
        }
        body { background-color: var(--primary-bg); color: var(--text-primary); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; margin: 0; display: flex; min-height: 100vh; }
        
        #mainMenu { width: 250px; flex-shrink: 0; background-color: #111533; padding-top: 20px; }
        #mainMenu a { display: block; padding: 15px 20px; color: var(--text-secondary); text-decoration: none; display: flex; align-items: center; gap: 10px; }
        #mainMenu a:hover, #mainMenu a.active { background-color: var(--card-bg); color: var(--accent-color); }
        
        .main-content { flex-grow: 1; padding: 2rem; overflow-y: auto; }
        
        #searchView, #detailsView { background-color: var(--card-bg); padding: 2rem; border-radius: 15px; max-width: 900px; margin: 0 auto; }
        
        h2 { color: var(--accent-color); margin-top: 0; }
        
        .form-group { margin-bottom: 1.5rem; }
        label { display: block; margin-bottom: 8px; color: var(--text-secondary); }
        input, textarea, select { width: 100%; background-color: var(--input-bg); border: 1px solid #33395b; color: white; padding: 12px; border-radius: 8px; box-sizing: border-box; }
        
        .btn { width: 100%; padding: 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 1rem; }
        .btn-primary { background: linear-gradient(90deg, #FF416C, #FFDE00); color: white; }
        .btn-secondary { background: #33395b; color: white; }
        .btn-cancel { background: #555; color: white; }
        
        #searchResultsContainer { margin-top: 20px; display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        .movie-card { background-color: var(--primary-bg); border-radius: 8px; overflow: hidden; cursor: pointer; transition: transform 0.2s; border: 1px solid #33395b; }
        .movie-card:hover { transform: translateY(-5px); border-color: var(--accent-color); }
        .movie-card img { width: 100%; height: 300px; object-fit: cover; }
        .movie-card h3 { padding: 10px; font-size: 0.9rem; margin: 0; text-align: center; }

        #detailsHeader { display: flex; gap: 20px; margin-bottom: 20px; border-bottom: 1px solid #33395b; padding-bottom: 20px; }
        #displayPoster { width: 120px; border-radius: 8px; }
        
        .checkbox-group { display: flex; flex-wrap: wrap; gap: 10px; max-height: 200px; overflow-y: auto; background: var(--input-bg); padding: 10px; border-radius: 8px; }
        .checkbox-label { display: flex; align-items: center; gap: 8px; background: #161b33; padding: 5px 10px; border-radius: 4px; border: 1px solid #33395b; font-size: 0.9rem; width: auto; cursor: pointer; }
        .checkbox-label:hover { border-color: var(--accent-color); }
        .checkbox-label input { width: auto; margin: 0; }

        .message { padding: 15px; border-radius: 8px; margin-top: 1rem; display: none; text-align: center; }
        .message.success { background-color: var(--success-color); }
        .message.error { background-color: var(--danger-color); }
    </style>
</head>
<body>

    <nav id="mainMenu">
        <a href="index.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
        <hr style="border-color: #333; margin: 10px 0;">
        <a href="manage-movies.html" class="active"><i class="fas fa-film"></i> Manage Movies</a>
        <a href="manage-series.html"><i class="fas fa-tv"></i> Manage Series</a>
        <a href="manage-banners.html"><i class="fas fa-images"></i> Manage Banners</a>
        <a href="manage-notifications.html"><i class="fas fa-paper-plane"></i> Notifications</a>
        <a href="manage-users.html"><i class="fas fa-users-cog"></i> User Management</a>
        <a href="all-content.html"><i class="fas fa-list-ul"></i> Browse All Content</a>
    </nav>

    <div class="main-content">
        
        <div id="searchView">
            <h2>Add New Movie</h2>
            <div class="form-group">
                <label>Search TMDB for a Movie</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="searchQuery" placeholder="e.g. Gladiator II">
                    <button id="searchTmdbBtn" class="btn btn-secondary" style="width: auto;">Search</button>
                </div>
            </div>
            <div id="searchResultsContainer"></div>
        </div>

        <div id="detailsView" style="display: none;">
            <div id="detailsHeader">
                <img id="displayPoster" src="" alt="Poster">
                <div>
                    <h2 id="displayTitle">Movie Title</h2>
                    <p id="displayOverview" style="color: var(--text-secondary); font-size: 0.9rem;"></p>
                </div>
            </div>

            <form id="movieForm">
                <input type="hidden" id="recordId"> 
                <input type="hidden" id="tmdb_id">
                <input type="hidden" id="posterUrl">
                <input type="hidden" id="backdropUrl">
                <input type="hidden" id="releaseYear">
                <!-- ✅ NEW: Stores the Clean Title (without year) for saving -->
                <input type="hidden" id="cleanTitle">

                <div class="form-group">
                    <label>Stream Link (Required)</label>
                    <input type="text" id="stream_link" placeholder="https://..." required>
                </div>
                
                <div class="form-group">
                    <label>VJ Name</label>
                    <div id="vjContainer" class="checkbox-group"></div>
                </div>

                <div class="form-group">
                    <label>Tags (For Home Page Sections & Genres)</label>
                    <div id="tagsContainer" class="checkbox-group"></div>
                </div>

                <div style="display: flex; gap: 15px;">
                    <button type="submit" class="btn btn-primary" id="saveBtn">Save to Database</button>
                    <button type="button" class="btn btn-cancel" id="cancelBtn">Cancel</button>
                </div>
            </form>
            <div id="formMessage" class="message"></div>
        </div>

    </div>
<script>
    const pb = new PocketBase('https://db.streamzonemovies.online');
    pb.autoCancellation(false);
    const TMDB_API_KEY = "f7a3b097ba7a990fd0c8ef3147646fb5"; 

    const GENRE_LIST = [
        "ACTION", "ADVENTURE", "LOVE STORY", "CRIME", "FAMILY", "SCI FI", 
        "KUNGU FU", "DRAMA", "SPORT", "THRILLER", "FANTASY", "HISTORY", "MYSTERY", "WAR",
        "HORROR", "ANIMATION", "COMEDY"
    ];
    
    const TAGS_LIST = [
        "latest_uploads", "romance", "recent_movies", "k_dramas", "indian", "horror",
        "action-thriller", "animation", "scifi-fantasy", "adventure", "high-school", 
        "comedy", "most_liked", "upcoming_shows",
        ...GENRE_LIST 
    ].filter((v, i, a) => a.indexOf(v) === i); 

    const VJ_LIST = ["VJ JUNIOR", "VJ TONNY", "VJ PAX", "VJ EMMY", "VJ LIGHT","VJ RYAN","VJ JOE", "HEAVY Q", "VJ MK","VJ HAM", "VJ MARK", "VJ SHIELD", "VJ ISMA K","VJ MOSCO", "ILLESS", "VJ BONNY", "VJ NEIL", "VJ JOVAN", "VJ TOM", "VJ SHAO K", "VJ JINGO", "VJ ICE P", "VJ KEVO", "VJ KEVIN", "VJ KIN", "VJ KRISS SWEET", "VJ HD", "VJ DAN DE", "VJ SAMMY", "VJ IVO", "VJ LITTLE T", "VJ LASH", "VJ MOX", "VJ MUBA", "VJ EDDY", "VJ KAM", "VJ LANCE", "VJ KS", "VJ ULIO", "VJ AARON", "VJ CABS", "VJ BANKS", "VJ JIMMY", "VJ BAROS", "VJ SOUL", "VJ SON", "VJ KIMULI", "VJ FREDY", "VJ JUMPERS", "VJ ASHIM", "VJ PAULETA", "VJ MARTIN K", "VJ HENRICO", "VJ MUSA", "VJ UNCLE T", "VJ WAZA", "VJ RONAGE"];

    const searchView = document.getElementById('searchView');
    const detailsView = document.getElementById('detailsView');
    const searchResults = document.getElementById('searchResultsContainer');
    const msgEl = document.getElementById('formMessage');
    const saveBtn = document.getElementById('saveBtn');

    function createCheckboxes(list, containerId, name) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        list.sort().forEach(item => {
            const label = document.createElement('label');
            label.className = 'checkbox-label';
            const displayText = item.replace(/_/g, ' ').replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            label.innerHTML = `<input type="checkbox" name="${name}" value="${item}"> ${displayText}`;
            container.appendChild(label);
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        createCheckboxes(VJ_LIST, 'vjContainer', 'vjs');
        createCheckboxes(TAGS_LIST, 'tagsContainer', 'tags');

        const urlParams = new URLSearchParams(window.location.search);
        const editId = urlParams.get('id');
        if (editId) loadMovieForEditing(editId);
    });

    document.getElementById('searchTmdbBtn').addEventListener('click', async () => {
        const query = document.getElementById('searchQuery').value;
        if (!query) return;
        searchResults.innerHTML = '<p>Searching...</p>';
        try {
            const res = await fetch(`https://api.themoviedb.org/3/search/movie?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(query)}`);
            const data = await res.json();
            searchResults.innerHTML = '';
            if (!data.results?.length) { searchResults.innerHTML = '<p>No results.</p>'; return; }
            data.results.forEach(movie => {
                const card = document.createElement('div');
                card.className = 'movie-card';
                const year = movie.release_date ? movie.release_date.split('-')[0] : '';
                card.innerHTML = `<img src="${movie.poster_path ? 'https://image.tmdb.org/t/p/w200'+movie.poster_path : 'https://placehold.co/200'}" ><h3>${movie.title} (${year})</h3>`;
                card.addEventListener('click', () => selectMovieFromSearch(movie));
                searchResults.appendChild(card);
            });
        } catch (err) { searchResults.innerHTML = `<p style="color:red">${err.message}</p>`; }
    });

    async function selectMovieFromSearch(movie) {
        const res = await fetch(`https://api.themoviedb.org/3/movie/${movie.id}?api_key=${TMDB_API_KEY}`);
        const fullData = await res.json();

        document.getElementById('recordId').value = ""; 
        saveBtn.innerText = "Save to Database";

        // Year Extraction
        let cleanYear = "";
        if (fullData.release_date) {
            cleanYear = fullData.release_date.split('-')[0];
        }
        document.getElementById('releaseYear').value = cleanYear;

        // ✅ IMPORTANT: Save clean title to hidden input, show Title (Year) in UI
        document.getElementById('cleanTitle').value = fullData.title; // Just "Troll 2"
        document.getElementById('displayTitle').textContent = fullData.title + (cleanYear ? ` (${cleanYear})` : ""); // UI: "Troll 2 (2025)"

        document.getElementById('displayOverview').textContent = fullData.overview;
        document.getElementById('displayPoster').src = fullData.poster_path ? `https://image.tmdb.org/t/p/w200${fullData.poster_path}` : '';
        document.getElementById('tmdb_id').value = fullData.id;
        document.getElementById('posterUrl').value = fullData.poster_path ? `https://image.tmdb.org/t/p/w500${fullData.poster_path}` : '';
        document.getElementById('backdropUrl').value = fullData.backdrop_path ? `https://image.tmdb.org/t/p/original${fullData.backdrop_path}` : '';

        // Auto-select genres
        document.querySelectorAll('input[name="tags"]').forEach(cb => cb.checked = false);
        if (fullData.genres) {
            fullData.genres.forEach(g => {
                const tmdbGenre = g.name.toUpperCase();
                const matchingTag = TAGS_LIST.find(tag => tag.toUpperCase() === tmdbGenre || (tmdbGenre === 'SCIENCE FICTION' && tag === 'SCI FI'));
                if(matchingTag){
                    const cb = document.querySelector(`input[name="tags"][value="${matchingTag}"]`);
                    if(cb) cb.checked = true;
                }
            });
        }
        const latestUploadsCheckbox = document.querySelector('input[name="tags"][value="latest_uploads"]');
        if(latestUploadsCheckbox) latestUploadsCheckbox.checked = true;

        searchView.style.display = 'none';
        detailsView.style.display = 'block';
    }

    async function loadMovieForEditing(id) {
        try {
            const record = await pb.collection('media').getOne(id);
            document.getElementById('recordId').value = record.id;
            
            // ✅ Load clean title
            document.getElementById('cleanTitle').value = record.title;
            document.getElementById('displayTitle').textContent = record.title; // When editing, we usually just show title, or title (year) if we prefer

            document.getElementById('displayOverview').textContent = record.description;
            document.getElementById('displayPoster').src = record.poster || '';
            document.getElementById('stream_link').value = record.stream_link || '';
            document.getElementById('tmdb_id').value = record.tmdb_id || '';
            document.getElementById('posterUrl').value = record.poster || '';
            document.getElementById('backdropUrl').value = record.backdrop || '';
            document.getElementById('releaseYear').value = record.year || '';

            const checkBoxes = (name, values) => {
                if(values && Array.isArray(values)) values.forEach(v => {
                    const cb = document.querySelector(`input[name="${name}"][value="${v}"]`);
                    if(cb) cb.checked = true;
                });
            };
            checkBoxes('vjs', record.vjs);
            checkBoxes('tags', record.tags); 

            searchView.style.display = 'none';
            detailsView.style.display = 'block';
            saveBtn.innerText = "Update Movie";
        } catch (err) { alert(err.message); window.location.href='all-content.html'; }
    }

    document.getElementById('movieForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        saveBtn.disabled = true; saveBtn.innerText = "Processing...";

        const getChecked = (name) => Array.from(document.querySelectorAll(`input[name="${name}"]:checked`)).map(cb => cb.value);

        const allSelectedTags = getChecked('tags');
        const selectedGenres = allSelectedTags.filter(tag => GENRE_LIST.includes(tag));

        const data = {
            title: document.getElementById('cleanTitle').value, // ✅ SAVES "Troll 2" (Not "Troll 2 (2025)")
            tmdb_id: document.getElementById('tmdb_id').value,
            description: document.getElementById('displayOverview').textContent,
            stream_link: document.getElementById('stream_link').value,
            poster: document.getElementById('posterUrl').value,
            backdrop: document.getElementById('backdropUrl').value,
            year: document.getElementById('releaseYear').value, 
            vjs: getChecked('vjs'),
            tags: allSelectedTags, 
            genres: selectedGenres,
            contentType: 'movie'
        };
        
        try {
            const id = document.getElementById('recordId').value;
            if (id) {
                await pb.collection('media').update(id, data);
            } else {
                await pb.collection('media').create(data);
            }
            
            msgEl.textContent = "Success! Movie saved correctly.";
            msgEl.className = "message success";
            msgEl.style.display = 'block';
            setTimeout(() => window.location.href='all-content.html', 1500);
        } catch (err) {
            msgEl.textContent = `Error: ${err.message}`;
            msgEl.className = "message error";
            msgEl.style.display = 'block';
            saveBtn.disabled = false;
            saveBtn.innerText = id ? "Update Movie" : "Save to Database";
        }
    });

    document.getElementById('cancelBtn').addEventListener('click', () => {
        const id = document.getElementById('recordId').value;
        if(id) {
            window.location.href='all-content.html';
        } else {
            detailsView.style.display = 'none';
            searchView.style.display = 'block';
            document.getElementById('movieForm').reset();
        }
    });
</script>
</body>
</html>