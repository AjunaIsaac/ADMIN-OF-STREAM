<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management - Admin Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="adminPanel">
       <nav id="mainMenu">
            <div class="menu-header">Admin Menu</div>
            <a href="index.html" class="active"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
            <hr style="border-color: #333; margin: 10px 0;">
            <a href="manage-movies.html"><i class="fas fa-film"></i> Manage Movies</a>
            <a href="manage-series.html"><i class="fas fa-tv"></i> Manage Series</a>
            <a href="manage-banners.html"><i class="fas fa-images"></i> Manage Banners</a>
            <a href="manage-notifications.html"><i class="fas fa-paper-plane"></i> Notifications</a>
            <a href="manage-users.html"><i class="fas fa-users-cog"></i> User Management</a>
            <a href="all-content.html"><i class="fas fa-list-ul"></i> Browse All Content</a>
        </nav>
        <div class="main-content">
            <div class="admin-header">
                <h1>User Management</h1>
                <button class="logout-btn" id="logoutBtn">Logout</button>
            </div>
            <div class="page-container" style="display: block;">
                <h2>User Management Panel</h2>
                <div class="form-group">
                    <label for="user-search-email">Search User by Email</label>
                    <input type="email" id="user-search-email" placeholder="user@example.com" />
                </div>
                <button id="user-search-btn">Search User</button>
                <div id="user-message-area" class="message" style="display: none;"></div>
                <hr id="user-form-divider" style="border-color: #444; margin: 20px 0; display: none;" />
                <div id="user-edit-form-section" style="display: none;">
                    <h3 id="user-form-title">Edit User</h3>
                    
                    <div class="status-badge-container">
                        Current Status: <span id="user-status-display"></span>
                    </div>

                    <div class="form-group"><label>Document ID (User UID)</label><input type="text" id="user-doc-id" readonly /></div>
                    <div class="form-group"><label for="user-edit-name">Full Name</label><input type="text" id="user-edit-name" /></div>
                    <div class="form-group"><label for="user-edit-email">Email</label><input type="email" id="user-edit-email" /></div>
                    <div class="form-group"><label for="user-edit-activated">Account Activated</label><select id="user-edit-activated"><option value="true">True</option><option value="false">False</option></select></div>
                    
                    <div class="form-group">
                        <label>Add Subscription Time</label>
                        <div class="subscription-buttons" id="subscription-buttons-container">
                            <button type="button" class="sub-button" data-duration="1" data-unit="day">+1 Day</button>
                            <button type="button" class="sub-button" data-duration="1" data-unit="week">+1 Week</button>
                            <button type="button" class="sub-button" data-duration="1" data-unit="month">+1 Month</button>
                            <button type="button" class="sub-button" data-duration="2" data-unit="month">+2 Months</button>
                            <button type="button" class="sub-button" data-duration="3" data-unit="month">+3 Months</button>
                            <button type="button" class="sub-button" data-duration="6" data-unit="month">+6 Months</button>
                            <button type="button" class="sub-button" data-duration="1" data-unit="year">+1 Year</button>
                        </div>
                    </div>

                    <div class="form-group"><label for="user-edit-expiresAt">Subscription Expiration (or set manually)</label><input type="datetime-local" id="user-edit-expiresAt" /></div>
                    
                    <button id="user-update-btn">Update Document</button>
                    <button id="user-create-btn" style="display: none;">Create New Document</button>
                </div>
            </div>
        </div>
    </div>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const firebaseConfig = { apiKey: "AIzaSyCgbaRR6ezvswehl1Q21ICHgBtXZ9bcLwA", authDomain: "my-movies-admin.firebaseapp.com", projectId: "my-movies-admin", storageBucket: "my-movies-admin.firebasestorage.app", messagingSenderId: "492775126123", appId: "1:492775126123:web:7ad51095ff15f61ed12d2e" };
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore(app);
    const auth = firebase.auth(app);

    const setLoading = (btn, isLoading) => { if(btn) { btn.classList.toggle('loading', isLoading); btn.disabled = isLoading; }};
    const displayMessage = (el, msg, type) => { if(el) { el.textContent = msg; el.className = `message ${type}`; el.style.display = 'block'; }};

    const userSearchEmailInput = document.getElementById('user-search-email');
    const userSearchBtn = document.getElementById('user-search-btn');
    const userMessageArea = document.getElementById('user-message-area');
    const userEditFormSection = document.getElementById('user-edit-form-section');
    const userFormDivider = document.getElementById('user-form-divider');
    const userDocIdInput = document.getElementById('user-doc-id');
    const userEditNameInput = document.getElementById('user-edit-name');
    const userEditEmailInput = document.getElementById('user-edit-email');
    const userEditActivatedSelect = document.getElementById('user-edit-activated');
    const userEditExpiresAtInput = document.getElementById('user-edit-expiresAt');
    const userUpdateBtn = document.getElementById('user-update-btn');
    const userCreateBtn = document.getElementById('user-create-btn');
    const userFormTitle = document.getElementById('user-form-title');
    const userStatusDisplay = document.getElementById('user-status-display');
    const subscriptionButtonsContainer = document.getElementById('subscription-buttons-container');

    auth.onAuthStateChanged(user => {
        if (!user) window.location.href = 'index.html';
    });
    document.getElementById('logoutBtn').addEventListener('click', () => auth.signOut());
    
    function clearUserForm() {
        userDocIdInput.value = '';
        userEditNameInput.value = '';
        userEditEmailInput.value = '';
        userEditActivatedSelect.value = 'true';
        userEditExpiresAtInput.value = '';
        userStatusDisplay.innerHTML = '';
        userEditFormSection.style.display = 'none';
        userFormDivider.style.display = 'none';
        userMessageArea.style.display = 'none';
    }

    function formatForInput(date) {
        if (!date) return '';
        const localDate = new Date(date.getTime() - (date.getTimezoneOffset() * 60000));
        return localDate.toISOString().slice(0, 16);
    }

    function displayUserStatus(expiresAtTimestamp) {
        if (!expiresAtTimestamp || typeof expiresAtTimestamp.toDate !== 'function') {
            userStatusDisplay.innerHTML = `<span class="status-badge" style="background-color: var(--info-color); color: white;">Never Subscribed</span>`;
            return;
        }
        const expiresDate = expiresAtTimestamp.toDate();
        const now = new Date();
        if (expiresDate > now) {
            userStatusDisplay.innerHTML = `<span class="status-badge" style="background-color: var(--success-color); color: white;">Active</span> (Expires: ${expiresDate.toLocaleString()})`;
        } else {
            userStatusDisplay.innerHTML = `<span class="status-badge" style="background-color: var(--danger-color); color: white;">Expired</span> (Expired on: ${expiresDate.toLocaleString()})`;
        }
    }

    userSearchBtn.addEventListener('click', async () => {
        const emailToSearch = userSearchEmailInput.value.trim();
        if (!emailToSearch) return;
        setLoading(userSearchBtn, true);
        try {
            const q = db.collection("users").where("email", "==", emailToSearch);
            const querySnapshot = await q.get();
            if (querySnapshot.empty) {
                displayMessage(userMessageArea, `No user found. You can create a new document for this email.`, 'info');
                clearUserForm();
                userEditEmailInput.value = emailToSearch;
                userFormTitle.textContent = "Create New User Document";
                userDocIdInput.value = "Will be auto-generated";
                userUpdateBtn.style.display = 'none';
                userCreateBtn.style.display = 'block';
            } else {
                const userDoc = querySnapshot.docs[0];
                const userData = userDoc.data();
                displayMessage(userMessageArea, 'User found.', 'success');
                userDocIdInput.value = userDoc.id;
                userEditNameInput.value = userData.name || '';
                userEditEmailInput.value = userData.email || '';
                userEditActivatedSelect.value = userData.activated ? 'true' : 'false';
                userEditExpiresAtInput.value = userData.expiresAt ? formatForInput(userData.expiresAt.toDate()) : '';
                displayUserStatus(userData.expiresAt);
                userFormTitle.textContent = "Edit User Document";
                userCreateBtn.style.display = 'none';
                userUpdateBtn.style.display = 'block';
            }
            userEditFormSection.style.display = 'block';
            userFormDivider.style.display = 'block';
        } catch (error) {
            displayMessage(userMessageArea, `Error searching: ${error.message}`, 'error');
        } finally {
            setLoading(userSearchBtn, false);
        }
    });

    subscriptionButtonsContainer.addEventListener('click', (e) => {
        const button = e.target.closest('.sub-button');
        if (!button) return;

        const duration = parseInt(button.dataset.duration);
        const unit = button.dataset.unit;

        const now = new Date();
        let startDate = now;
        
        // If there's an existing, valid expiration date, use it as the start date
        const existingExpiryValue = userEditExpiresAtInput.value;
        if (existingExpiryValue) {
            const existingExpiryDate = new Date(existingExpiryValue);
            // If the existing subscription is still active, extend it. Otherwise, start from now.
            if (existingExpiryDate > now) {
                startDate = existingExpiryDate;
            }
        }
        
        const newDate = new Date(startDate);

        switch (unit) {
            case 'day': newDate.setDate(newDate.getDate() + duration); break;
            case 'week': newDate.setDate(newDate.getDate() + (duration * 7)); break;
            case 'month': newDate.setMonth(newDate.getMonth() + duration); break;
            case 'year': newDate.setFullYear(newDate.getFullYear() + duration); break;
        }

        userEditExpiresAtInput.value = formatForInput(newDate);
    });

    userUpdateBtn.addEventListener('click', async () => {
        const userId = userDocIdInput.value;
        if (!userId) return;
        setLoading(userUpdateBtn, true);
        try {
            const dateValue = userEditExpiresAtInput.value ? new Date(userEditExpiresAtInput.value) : null;
            await db.collection("users").doc(userId).update({
                name: userEditNameInput.value,
                email: userEditEmailInput.value,
                activated: userEditActivatedSelect.value === 'true',
                expiresAt: dateValue ? firebase.firestore.Timestamp.fromDate(dateValue) : null
            });
            displayMessage(userMessageArea, 'User document updated!', 'success');
            // Refresh status after update
            displayUserStatus(dateValue ? firebase.firestore.Timestamp.fromDate(dateValue) : null);
        } catch (error) {
            displayMessage(userMessageArea, `Update failed: ${error.message}`, 'error');
        } finally {
            setLoading(userUpdateBtn, false);
        }
    });

    userCreateBtn.addEventListener('click', async () => {
        const email = userEditEmailInput.value.trim();
        if (!email) return;
        setLoading(userCreateBtn, true);
        try {
            const newDocRef = db.collection("users").doc();
            const dateValue = userEditExpiresAtInput.value ? new Date(userEditExpiresAtInput.value) : null;
            await newDocRef.set({
                name: userEditNameInput.value, email: email,
                activated: userEditActivatedSelect.value === 'true',
                expiresAt: dateValue ? firebase.firestore.Timestamp.fromDate(dateValue) : null,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            });
            userDocIdInput.value = newDocRef.id;
            displayMessage(userMessageArea, `New document created: ${newDocRef.id}`, 'success');
            displayUserStatus(dateValue ? firebase.firestore.Timestamp.fromDate(dateValue) : null);
            userCreateBtn.style.display = 'none';
            userUpdateBtn.style.display = 'block';
            userFormTitle.textContent = 'Edit User Document';
        } catch (error) {
            displayMessage(userMessageArea, `Creation failed: ${error.message}`, 'error');
        } finally {
            setLoading(userCreateBtn, false);
        }
    });
});
</script>
</body>
</html>