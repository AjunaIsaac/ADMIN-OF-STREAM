<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Banners - Admin Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* --- Redesign Styles --- */
        :root {
            --primary-bg: #0A0F2A;
            --card-bg: #1C2141;
            --accent-color: #DFFF00;
            --text-primary: #FFFFFF;
            --text-secondary: #a9a9b3;
            --logout-bg: #e74c3c;
            --input-bg: #0A0F2A;
            --danger-color: #e74c3c;
        }

        body { background-color: var(--primary-bg); color: var(--text-primary); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; margin: 0; }
        #adminPanel { display: flex; }
        #mainMenu { width: 250px; flex-shrink: 0; background-color: #111533; min-height: 100vh; transition: transform 0.3s ease; z-index: 1000; }
        #mainMenu a { display: block; padding: 15px 20px; color: var(--text-secondary); text-decoration: none; transition: background-color 0.3s, color 0.3s; }
        #mainMenu a:hover, #mainMenu a.active { background-color: var(--card-bg); color: var(--accent-color); }
        #mainMenu .menu-header { padding: 20px; font-size: 1.2rem; font-weight: 600; color: var(--text-primary); }
        #mainMenu a i { margin-right: 10px; }
        .main-content { flex-grow: 1; padding: 1.5rem; }
        .admin-header { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: flex-start; gap: 15px; margin-bottom: 10px; }
        .header-title-section { flex-grow: 1; }
        .admin-header h1 { color: var(--accent-color); font-size: 2.5rem; font-weight: 700; line-height: 1.1; margin: 0; }
        .user-info { color: var(--text-secondary); font-size: 0.9rem; margin-top: 10px; }
        #menuToggleBtn { display: block; position: static; background: transparent; color: var(--accent-color); border: 2px solid var(--accent-color); border-radius: 8px; width: 50px; height: 50px; font-size: 1.5rem; cursor: pointer; padding: 0; margin-right: 20px; }
        .logout-btn { background-color: var(--logout-bg); color: white; border: none; border-radius: 8px; padding: 12px 20px; font-size: 1rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; }
        
        /* Card and Form Styles */
        .page-container { background-color: var(--card-bg); padding: 2rem; border-radius: 15px; margin-top: 1rem; }
        .page-container h2 { font-size: 1.2rem; color: var(--text-primary); margin: 0 0 1rem 0; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 5px; color: var(--text-secondary); }
        .form-group input[type="text"], .form-group input[type="url"], .form-group textarea { width: 100%; background-color: var(--input-bg); border: 1px solid #33395b; border-radius: 8px; padding: 15px; color: var(--text-primary); font-size: 1rem; box-sizing: border-box; font-family: inherit; }
        
        /* Buttons */
        button { cursor: pointer; transition: transform 0.2s ease; }
        button:hover { transform: scale(1.02); }
        #saveBannerBtn, #bannerSearchBtn { background: linear-gradient(90deg, #FF416C, #FFDE00); color: white; border: none; border-radius: 8px; padding: 15px; font-size: 1.1rem; font-weight: 700; }
        
        /* Banner Page Specific Styles */
        .banner-nav-tabs { display: flex; gap: 10px; border-bottom: 1px solid #33395b; margin-bottom: 2rem; }
        .banner-tab-link { background: transparent; color: var(--text-secondary); border: 1px solid #33395b; padding: 10px 20px; border-radius: 8px; font-size: 1rem; }
        .banner-tab-link.active { background-color: var(--accent-color); color: var(--primary-bg); border-color: var(--accent-color); font-weight: 600; }
        #allBannersContainer { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem; }
        .dashboard-card { background-color: var(--primary-bg); border-radius: 15px; padding: 1.5rem; }
        .banner-card-image { width: 100%; height: 170px; object-fit: cover; border-radius: 8px; margin-bottom: 1rem; }
        .dashboard-card h3 { margin: 0 0 0.5rem 0; color: var(--text-primary); }
        .dashboard-card p { color: var(--text-secondary); font-size: 0.9rem; }
        .action-btn { padding: 10px; border: none; border-radius: 8px; font-weight: 600; }
        .action-btn.edit { background-color: var(--accent-color); color: var(--primary-bg); }
        .action-btn.delete { background-color: var(--danger-color); color: white; }
        .content-card { background-color: var(--primary-bg); padding: 1rem; border-radius: 8px; margin-top: 1rem; }
        .content-card-content { display: flex; align-items: center; gap: 1rem; }
        .content-card-poster img { width: 60px; border-radius: 4px; }
        
        .message { padding: 15px; border-radius: 8px; margin-top: 1rem; display: none; }
        .message.success { background-color: #27ae60; color: white; }
        .message.error { background-color: var(--danger-color); color: white; }
        .message.info { background-color: #3498db; color: white; }
        
        /* Mobile */
        @media (max-width: 768px) {
            #adminPanel { flex-direction: column; }
            .admin-header { align-items: center; }
            .admin-header h1 { font-size: 2rem; }
            #mainMenu { position: fixed; left: 0; top: 0; height: 100%; transform: translateX(-100%); }
            #mainMenu.open { transform: translateX(0); }
        }
        @media (min-width: 769px) { #menuToggleBtn { display: none; } }
    </style>
</head>
<body>
    <div id="adminPanel">
        <nav id="mainMenu">
            <div class="menu-header">Admin Menu</div>
            <a href="index.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
            <hr style="border-color: #333; margin: 10px 0;">
            <a href="manage-movies.html"><i class="fas fa-film"></i> Manage Movies</a>
            <a href="manage-series.html"><i class="fas fa-tv"></i> Manage Series</a>
            <a href="manage-banners.html" class="active"><i class="fas fa-images"></i> Manage Banners</a>
            <a href="manage-notifications.html"><i class="fas fa-paper-plane"></i> Notifications</a>
            <a href="manage-users.html"><i class="fas fa-users-cog"></i> User Management</a>
        </nav>

        <div class="main-content">
            <div class="admin-header">
                <div style="display: flex; align-items: center;">
                    <button id="menuToggleBtn"><i class="fas fa-bars"></i></button>
                    <div class="header-title-section">
                        <h1>Manage<br>Banners</h1>
                    </div>
                </div>
                <button class="logout-btn" id="logoutBtn">Logout <i class="fas fa-sign-out-alt"></i></button>
            </div>
            
            <p class="user-info">Logged in as: support@streamzonemovies.online</p>

            <div class="page-container" style="background: none; padding: 0; margin-top: 1rem; border: none;">
                <div class="banner-nav-tabs">
                    <button class="banner-tab-link active" data-tab="viewBannersTab">View All Banners</button>
                    <button class="banner-tab-link" data-tab="addBannerTab">Add / Edit Banner</button>
                </div>
                
                <div id="addBannerTab" class="page-container" style="display: none;">
                    <div id="bannerSearchSection">
                        <h2>1. Find Content for Banner Link</h2>
                        <div class="form-group"><label for="bannerSearchQuery">Search for a Movie or Series in Your Database</label><input type="text" id="bannerSearchQuery" placeholder="Enter title to search..."></div>
                        <button id="bannerSearchBtn" type="button" style="width: auto; padding: 10px 20px;">Search Content</button>
                        <div id="bannerSearchResults" style="margin-top: 20px;"></div>
                    </div>
                    
                    <hr style="border-color: #444; margin: 30px 0;">

                    <div id="bannerFormSection">
                        <h2 id="bannerFormTitle">2. Create or Edit Banner</h2>
                        <form id="addEditBannerForm">
                            <input type="hidden" id="bannerDocId">
                            <div class="form-group"><label for="bannerTitle">Banner Title (Auto-filled)</label><input type="text" id="bannerTitle" required></div>
                            <div class="form-group"><label for="bannerImageUrl">Image URL (Auto-filled)</label><input type="url" id="bannerImageUrl" required></div>
                            <div class="form-group"><label for="bannerDescription">Description (Auto-filled)</label><textarea id="bannerDescription" rows="3"></textarea></div>
                            <div class="form-group"><label for="bannerLink">"Watch Now" Link (Auto-filled)</label><input type="text" id="bannerLink" required></div>
                            <button type="submit" id="saveBannerBtn">Save Banner</button>
                            <button type="button" id="cancelEditBannerBtn" style="display:none; background-color: gray; margin-top: 10px;">Cancel / New</button>
                        </form>
                        <div id="addBannerMessage" class="message"></div>
                    </div>
                </div>

                <div id="viewBannersTab" class="page-container active">
                    <h2>All Available Banners</h2>
                    <div id="allBannersContainer"></div>
                    <div id="viewBannersMessage" class="message"></div>
                </div>
            </div>
        </div>
    </div>
    
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- THIS SCRIPT IS THE ORIGINAL, FUNCTIONAL VERSION ---

    const firebaseConfig = { apiKey: "AIzaSyCgbaRR6ezvswehl1Q21ICHgBtXZ9bcLwA", authDomain: "my-movies-admin.firebaseapp.com", projectId: "my-movies-admin", storageBucket: "my-movies-admin.firebasestorage.app", messagingSenderId: "492775126123", appId: "1:492775126123:web:7ad51095ff15f61ed12d2e" };
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore(app);
    const auth = firebase.auth(app);

    const setLoading = (btn, isLoading) => { if(btn) { btn.classList.toggle('loading', isLoading); btn.disabled = isLoading; }};
    const displayMessage = (el, msg, type) => { if(el) { el.textContent = msg; el.className = `message ${type}`; el.style.display = 'block'; setTimeout(() => { el.style.display = 'none'; }, 5000); }};

    const addEditBannerForm = document.getElementById('addEditBannerForm');
    const bannerFormTitle = document.getElementById('bannerFormTitle');
    const bannerDocId = document.getElementById('bannerDocId');
    const saveBannerBtn = document.getElementById('saveBannerBtn');
    const cancelEditBannerBtn = document.getElementById('cancelEditBannerBtn');
    const addBannerMessage = document.getElementById('addBannerMessage');
    const allBannersContainer = document.getElementById('allBannersContainer');
    const viewBannersMessage = document.getElementById('viewBannersMessage');
    const viewBannersTab = document.getElementById('viewBannersTab');
    const addBannerTab = document.getElementById('addBannerTab');
    const bannerSearchBtn = document.getElementById('bannerSearchBtn');
    const bannerSearchResults = document.getElementById('bannerSearchResults');
    const menuToggleBtn = document.getElementById('menuToggleBtn');
    const mainMenu = document.getElementById('mainMenu');

    auth.onAuthStateChanged(user => {
        if (!user) window.location.href = 'index.html';
        else displayAllBanners();
    });
    
    if (menuToggleBtn && mainMenu) {
        menuToggleBtn.addEventListener('click', () => mainMenu.classList.toggle('open'));
    }
    
    document.getElementById('logoutBtn').addEventListener('click', () => auth.signOut());

    // CORRECTED TAB SWITCHING LOGIC (FROM YOUR ORIGINAL FILE)
    document.querySelectorAll('.banner-tab-link').forEach(tab => {
        tab.addEventListener('click', () => {
            document.querySelectorAll('.banner-tab-link').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            if (tab.dataset.tab === 'viewBannersTab') {
                viewBannersTab.classList.add('active');
                viewBannersTab.style.display = 'block'; // Ensure it's visible
                addBannerTab.style.display = 'none';
                displayAllBanners();
            } else {
                viewBannersTab.classList.remove('active');
                viewBannersTab.style.display = 'none'; // Ensure it's hidden
                addBannerTab.style.display = 'block';
                resetBannerForm(false); // Reset form without switching tab
            }
        });
    });

    async function displayAllBanners() {
        allBannersContainer.innerHTML = '<p class="message info" style="display:block">Loading banners...</p>';
        try {
            const snapshot = await db.collection('banners').orderBy('createdAt', 'desc').get();
            if (snapshot.empty) {
                allBannersContainer.innerHTML = '<p>No banners found. Click "Add / Edit Banner" to create one.</p>';
                return;
            }
            allBannersContainer.innerHTML = '';
            snapshot.forEach(doc => {
                const banner = { id: doc.id, ...doc.data() };
                const card = document.createElement('div');
                card.className = 'dashboard-card';
                card.innerHTML = `
                    <img src="${banner.imageUrl}" alt="${banner.title}" class="banner-card-image">
                    <h3>${banner.title}</h3>
                    <p>${(banner.description || 'No description provided.').substring(0, 100)}...</p>
                    <div style="margin-top:15px; display:flex; gap:10px;">
                        <button type="button" class="action-btn edit" data-id="${banner.id}" style="width: 50%;">Edit</button>
                        <button type="button" class="action-btn delete" data-id="${banner.id}" style="width: 50%;">Delete</button>
                    </div>
                `;
                allBannersContainer.appendChild(card);
            });
        } catch (err) {
            displayMessage(viewBannersMessage, `Error: ${err.message}`, 'error');
        }
    }

    async function loadBannerForEditing(id) {
        try {
            const doc = await db.collection('banners').doc(id).get();
            if (doc.exists) {
                const data = doc.data();
                bannerDocId.value = id;
                document.getElementById('bannerTitle').value = data.title || '';
                document.getElementById('bannerImageUrl').value = data.imageUrl || '';
                document.getElementById('bannerDescription').value = data.description || '';
                document.getElementById('bannerLink').value = data.link || '';
                bannerFormTitle.textContent = 'Editing Banner';
                saveBannerBtn.textContent = 'Update Banner';
                cancelEditBannerBtn.style.display = 'block';
                document.querySelector('.banner-tab-link[data-tab="addBannerTab"]').click();
                bannerSearchResults.innerHTML = ''; // Hide search results when editing
            }
        } catch (err) {
            displayMessage(addBannerMessage, 'Could not load banner for editing.', 'error');
        }
    }

    function resetBannerForm(switchToViewTab = true) {
        addEditBannerForm.reset();
        bannerDocId.value = '';
        bannerFormTitle.textContent = '2. Create or Edit Banner';
        saveBannerBtn.textContent = 'Save Banner';
        cancelEditBannerBtn.style.display = 'none';
        bannerSearchResults.innerHTML = '';
        document.getElementById('bannerSearchQuery').value = '';
        if (switchToViewTab) {
            document.querySelector('.banner-tab-link[data-tab="viewBannersTab"]').click();
        }
    }

    bannerSearchBtn.addEventListener('click', async () => {
        const query = document.getElementById('bannerSearchQuery').value.trim().toLowerCase();
        if (!query) return;
        setLoading(bannerSearchBtn, true);
        bannerSearchResults.innerHTML = '<p class="message info" style="display:block">Searching your database...</p>';
        try {
            const snapshot = await db.collection('movies').get();
            const results = snapshot.docs.filter(doc => doc.data().title && doc.data().title.toLowerCase().includes(query));
            
            if (results.length === 0) {
                bannerSearchResults.innerHTML = '<p>No content found in your database.</p>';
                return;
            }
            bannerSearchResults.innerHTML = '';
            results.forEach(doc => {
                const item = { id: doc.id, ...doc.data() };
                const resultCard = document.createElement('div');
                resultCard.className = 'content-card';
                resultCard.innerHTML = `
                    <div class="content-card-content">
                        <div class="content-card-poster"><img src="${item.posterUrl || ''}" alt="poster"></div>
                        <div class="content-card-info">
                            <h3>${item.title}</h3>
                            <p>VJ: ${item.vjName} [${item.contentType}]</p>
                            <button class="action-btn edit select-btn" type="button" data-id="${item.id}">Use This Content</button>
                        </div>
                    </div>`;
                bannerSearchResults.appendChild(resultCard);
            });
        } catch (err) {
            displayMessage(addBannerMessage, `Error searching: ${err.message}`, 'error');
        } finally {
            setLoading(bannerSearchBtn, false);
        }
    });

    bannerSearchResults.addEventListener('click', async (e) => {
        if (e.target.classList.contains('select-btn')) {
            const docId = e.target.dataset.id;
            const doc = await db.collection('movies').doc(docId).get();
            if (doc.exists) {
                const data = doc.data();
                const uniqueId = data.unique_reference_id || doc.id;
                
                document.getElementById('bannerTitle').value = data.title;
                document.getElementById('bannerImageUrl').value = data.backdropUrl || data.posterUrl || '';
                document.getElementById('bannerDescription').value = data.overview;
                document.getElementById('bannerLink').value = `yourapp://details?id=${uniqueId}`;
                
                bannerSearchResults.innerHTML = ''; // Clear results after selection
                displayMessage(addBannerMessage, "Form has been auto-filled!", "success");
            }
        }
    });

    allBannersContainer.addEventListener('click', async e => {
        const target = e.target.closest('button');
        if (!target) return;

        if (target.classList.contains('edit')) {
            await loadBannerForEditing(target.dataset.id);
        }
        if (target.classList.contains('delete')) {
            if (confirm('Are you sure you want to delete this banner?')) {
                try {
                    setLoading(target, true);
                    await db.collection('banners').doc(target.dataset.id).delete();
                    displayMessage(viewBannersMessage, 'Banner deleted.', 'success');
                    displayAllBanners();
                } catch (err) {
                    displayMessage(viewBannersMessage, `Error deleting: ${err.message}`, 'error');
                } finally {
                    setLoading(target, false);
                }
            }
        }
    });

    addEditBannerForm.addEventListener('submit', async e => {
        e.preventDefault();
        setLoading(saveBannerBtn, true);
        const id = bannerDocId.value;
        const data = {
            title: document.getElementById('bannerTitle').value.trim(),
            imageUrl: document.getElementById('bannerImageUrl').value.trim(),
            description: document.getElementById('bannerDescription').value.trim(),
            link: document.getElementById('bannerLink').value.trim(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        try {
            if (id) {
                await db.collection('banners').doc(id).update(data);
            } else {
                data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                await db.collection('banners').add(data);
            }
            displayMessage(addBannerMessage, 'Banner saved successfully!', 'success');
            setTimeout(() => resetBannerForm(true), 1500);
        } catch (err) {
            displayMessage(addBannerMessage, `Error saving banner: ${err.message}`, 'error');
        } finally {
            setLoading(saveBannerBtn, false);
        }
    });

    cancelEditBannerBtn.addEventListener('click', () => resetBannerForm(false));
});
</script>
</body>
</html>