<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Series - Admin Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- PocketBase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/pocketbase@latest/dist/pocketbase.umd.js"></script>
    <style>
        :root {
            --primary-bg: #0A0F2A; --card-bg: #1C2141; --accent-color: #DFFF00;
            --text-primary: #FFFFFF; --text-secondary: #a9a9b3; --input-bg: #0A0F2A;
            --success-color: #27ae60; --danger-color: #f44336; --info-color: #2196F3;
        }
        body { background-color: var(--primary-bg); color: var(--text-primary); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; margin: 0; display: flex; min-height: 100vh; }
        
        #mainMenu { width: 250px; flex-shrink: 0; background-color: #111533; padding-top: 20px; }
        #mainMenu a { display: block; padding: 15px 20px; color: var(--text-secondary); text-decoration: none; display: flex; align-items: center; gap: 10px; }
        #mainMenu a:hover, #mainMenu a.active { background-color: var(--card-bg); color: var(--accent-color); }
        
        .main-content { flex-grow: 1; padding: 2rem; overflow-y: auto; }
        
        /* Views */
        #searchView, #detailsView { background-color: var(--card-bg); padding: 2rem; border-radius: 15px; max-width: 1000px; margin: 0 auto; }
        
        h2 { color: var(--accent-color); margin-top: 0; }
        
        .form-group { margin-bottom: 1.5rem; }
        label { display: block; margin-bottom: 8px; color: var(--text-secondary); }
        input[type="text"], input[type="url"], input[type="number"] { width: 100%; background-color: var(--input-bg); border: 1px solid #33395b; color: white; padding: 12px; border-radius: 8px; box-sizing: border-box; }
        
        .btn { padding: 12px 20px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; color: white; margin-top: 10px; }
        .btn-primary { background: linear-gradient(90deg, #FF416C, #FFDE00); width: 100%; }
        .btn-secondary { background: #33395b; }
        .btn-success { background: var(--success-color); }
        
        /* Episode Table */
        .episode-table-wrapper { overflow-x: auto; margin-top: 20px; border: 1px solid #33395b; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { padding: 12px; border-bottom: 1px solid #33395b; text-align: left; vertical-align: middle; }
        th { background-color: #0e1229; color: var(--accent-color); }
        tr.season-header { background-color: #161b33; font-weight: bold; color: var(--accent-color); text-align: center; }
        td input { padding: 8px; border-radius: 4px; border: 1px solid #444; width: 100%; }
        
        .thumbnail-preview { width: 80px; height: 45px; object-fit: cover; border-radius: 4px; background: #000; vertical-align: middle; margin-right: 10px; }
        
        /* Checkboxes */
        .checkbox-group { display: flex; flex-wrap: wrap; gap: 10px; background: var(--input-bg); padding: 10px; border-radius: 8px; max-height: 150px; overflow-y: auto; }
        .checkbox-label { background: #161b33; padding: 5px 10px; border-radius: 4px; border: 1px solid #33395b; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .checkbox-label input { width: auto; margin: 0; }

        .message { padding: 15px; border-radius: 8px; margin-top: 1rem; display: none; text-align: center; }
        .message.success { background-color: var(--success-color); }
        .message.error { background-color: var(--danger-color); }

        #searchResultsContainer { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-top: 20px; }
        .series-card { background: var(--primary-bg); border-radius: 8px; cursor: pointer; overflow: hidden; border: 1px solid #333; text-align: center; }
        .series-card img { width: 100%; height: 300px; object-fit: cover; }
        .series-card h3 { padding: 10px; font-size: 0.9rem; margin: 0; }
    </style>
</head>
<body>

   <nav id="mainMenu">
            <div class="menu-header">Admin Menu</div>
            <a href="index.html" class="active"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
            <hr style="border-color: #333; margin: 10px 0;">
            <a href="manage-movies.html"><i class="fas fa-film"></i> Manage Movies</a>
            <a href="manage-series.html"><i class="fas fa-tv"></i> Manage Series</a>
            <a href="manage-banners.html"><i class="fas fa-images"></i> Manage Banners</a>
            <a href="manage-notifications.html"><i class="fas fa-paper-plane"></i> Notifications</a>
            <a href="manage-users.html"><i class="fas fa-users-cog"></i> User Management</a>
            <a href="all-content.html"><i class="fas fa-list-ul"></i> Browse All Content</a>
        </nav>

    <div class="main-content">
        
        <!-- SEARCH VIEW -->
        <div id="searchView">
            <h2>Search TMDB for Series</h2>
            <div class="form-group">
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="seriesSearchQuery" placeholder="e.g. Breaking Bad">
                    <button id="searchTmdbBtn" class="btn btn-secondary">Search</button>
                </div>
            </div>
            <div id="searchResultsContainer"></div>
        </div>

        <!-- DETAILS VIEW -->
        <div id="detailsView" style="display: none;">
            <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                <img id="seriesPoster" src="" style="width: 120px; border-radius: 8px;">
                <div>
                    <h2 id="seriesTitle">Title</h2>
                    <p id="seriesOverview" style="font-size: 0.9rem; color: #ccc;"></p>
                </div>
            </div>

            <form id="seriesForm">
                <input type="hidden" id="recordId">
                <input type="hidden" id="tmdbId">
                <input type="hidden" id="posterUrl">
                <input type="hidden" id="backdropUrl">
                <input type="hidden" id="firstAirDate">

                <div class="form-group">
                    <label>VJ Name (Required)</label>
                    <div id="vjContainer" class="checkbox-group"></div>
                </div>

                <div class="form-group">
                    <label>Genres</label>
                    <div id="genreContainer" class="checkbox-group"></div>
                </div>

                <h3>Episodes Manager</h3>
                <div class="episode-table-wrapper">
                    <table id="episodesTable">
                        <thead>
                            <tr>
                                <th style="width: 50px;">Ep</th>
                                <th>Details</th>
                                <th>Video Link (Required)</th>
                            </tr>
                        </thead>
                        <tbody id="episodesTableBody">
                            <!-- Rows injected via JS -->
                        </tbody>
                    </table>
                </div>

                <div style="display: flex; gap: 15px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary" id="saveBtn">Save Series</button>
                    <button type="button" class="btn btn-secondary" onclick="location.reload()">Cancel</button>
                </div>
            </form>
            <div id="formMessage" class="message"></div>
        </div>

    </div>
<script>
    const pb = new PocketBase('https://db.streamzonemovies.online');
    pb.autoCancellation(false);
    const TMDB_API_KEY = "f7a3b097ba7a990fd0c8ef3147646fb5";

    const VJ_LIST = ["VJ JUNIOR", "VJ TONNY", "VJ PAX", "VJ EMMY", "VJ LIGHT","VJ RYAN","VJ JOE", "HEAVY Q", "VJ MK","VJ HAM", "VJ MARK", "VJ SHIELD", "VJ ISMA K","VJ MOSCO", "ILLESS", "VJ BONNY", "VJ NEIL", "VJ JOVAN", "VJ TOM", "VJ SHAO K", "VJ JINGO", "VJ ICE P", "VJ KEVO", "VJ KEVIN", "VJ KIN", "VJ KRISS SWEET", "VJ HD", "VJ DAN DE", "VJ SAMMY", "VJ IVO", "VJ LITTLE T", "VJ LASH", "VJ MOX", "VJ MUBA", "VJ EDDY", "VJ KAM", "VJ LANCE", "VJ KS", "VJ ULIO", "VJ AARON", "VJ CABS", "VJ BANKS", "VJ JIMMY", "VJ BAROS", "VJ SOUL", "VJ SON", "VJ KIMULI", "VJ FREDY", "VJ JUMPERS", "VJ ASHIM", "VJ PAULETA", "VJ MARTIN K", "VJ HENRICO", "VJ MUSA", "VJ UNCLE T", "VJ WAZA", "VJ RONAGE"];
    const GENRE_LIST = ["ACTION", "HORROR", "ADVENTURE", "LOVE STORY", "COMEDY", "CRIME", "FAMILY", "SCI FI", "ROMANCE", "KUNGU FU", "DRAMA", "SPORT", "THRILLER", "ANIMATION", "DOCUMENTARY", "FANTASY", "HISTORY", "MYSTERY", "WAR"];
    
    // ✅ NEW: Special Categories for Series
    const SPECIAL_CATEGORIES = [
        { label: "Trending This Week", value: "trending" },
        { label: "Western Series", value: "western_series" },
        { label: "K-Dramas", value: "k_dramas" },
        { label: "Latest on Jmovies", value: "latest_on_jmovies" }
    ];

    const searchView = document.getElementById('searchView');
    const detailsView = document.getElementById('detailsView');
    const searchResults = document.getElementById('searchResultsContainer');
    const episodesBody = document.getElementById('episodesTableBody');
    const msgEl = document.getElementById('formMessage');
    const saveBtn = document.getElementById('saveBtn');

    function createCheckboxes(list, containerId, name, isObject=false) {
        const container = document.getElementById(containerId);
        if (!container) return;
        container.innerHTML = '';
        list.forEach(item => {
            const label = document.createElement('label');
            label.className = 'checkbox-label';
            const value = isObject ? item.value : item;
            const text = isObject ? item.label : item;
            label.innerHTML = `<input type="checkbox" name="${name}" value="${value}"> ${text}`;
            container.appendChild(label);
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        createCheckboxes(VJ_LIST, 'vjContainer', 'vjs');
        createCheckboxes(GENRE_LIST, 'genreContainer', 'genres');
        
        // ✅ Inject Special Categories
        let catContainer = document.getElementById('categoryContainer');
        if (!catContainer) {
            const formGroup = document.createElement('div');
            formGroup.className = 'form-group';
            formGroup.innerHTML = `<label>Special Categories</label><div id="categoryContainer" class="checkbox-group"></div>`;
            document.getElementById('genreContainer').parentElement.after(formGroup);
            catContainer = document.getElementById('categoryContainer');
        }
        createCheckboxes(SPECIAL_CATEGORIES, 'categoryContainer', 'type', true);

        const urlParams = new URLSearchParams(window.location.search);
        const editId = urlParams.get('id');
        if (editId) loadSeriesForEditing(editId);
    });

    document.getElementById('searchTmdbBtn').addEventListener('click', async () => {
        const query = document.getElementById('seriesSearchQuery').value;
        if (!query) return;
        searchResults.innerHTML = '<p style="color:white">Searching...</p>';
        try {
            const res = await fetch(`https://api.themoviedb.org/3/search/tv?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(query)}`);
            const data = await res.json();
            searchResults.innerHTML = '';
            if (!data.results?.length) { searchResults.innerHTML = '<p>No results.</p>'; return; }
            data.results.forEach(series => {
                const card = document.createElement('div');
                card.className = 'series-card';
                card.innerHTML = `<img src="${series.poster_path ? 'https://image.tmdb.org/t/p/w200'+series.poster_path : 'https://placehold.co/200'}" ><h3>${series.name}</h3>`;
                card.addEventListener('click', () => loadTmdbDetails(series.id));
                searchResults.appendChild(card);
            });
        } catch (e) { alert(e.message); }
    });

    async function loadTmdbDetails(tmdbId, existingData = null) {
        if (!tmdbId) { alert("Missing TMDB ID"); return; }
        searchView.style.display = 'none'; detailsView.style.display = 'block';
        episodesBody.innerHTML = '<tr><td colspan="3">Loading...</td></tr>';

        try {
            const res = await fetch(`https://api.themoviedb.org/3/tv/${tmdbId}?api_key=${TMDB_API_KEY}`);
            const data = await res.json();

            document.getElementById('seriesTitle').textContent = data.name;
            document.getElementById('seriesOverview').textContent = data.overview;
            document.getElementById('seriesPoster').src = data.poster_path ? `https://image.tmdb.org/t/p/w500${data.poster_path}` : '';
            document.getElementById('tmdbId').value = String(data.id);
            document.getElementById('posterUrl').value = data.poster_path ? `https://image.tmdb.org/t/p/w500${data.poster_path}` : '';
            document.getElementById('backdropUrl').value = data.backdrop_path ? `https://image.tmdb.org/t/p/original${data.backdrop_path}` : '';
            document.getElementById('firstAirDate').value = data.first_air_date || '';

            // Auto-Genres
            if (data.genres && !existingData) {
                document.querySelectorAll('input[name="genres"]').forEach(cb => cb.checked = false);
                data.genres.forEach(g => {
                    const tmdbG = g.name.toUpperCase();
                    document.querySelectorAll('input[name="genres"]').forEach(cb => {
                        const myG = cb.value.toUpperCase();
                        if (tmdbG.includes(myG) || (tmdbG.includes("SCI") && myG === "SCI FI")) cb.checked = true;
                    });
                });
            }

            episodesBody.innerHTML = '';
            for (const season of data.seasons) {
                if (season.season_number === 0) continue;
                const header = document.createElement('tr');
                header.className = 'season-header';
                header.innerHTML = `<td colspan="3">Season ${season.season_number}</td>`;
                episodesBody.appendChild(header);

                const sRes = await fetch(`https://api.themoviedb.org/3/tv/${tmdbId}/season/${season.season_number}?api_key=${TMDB_API_KEY}`);
                const sData = await sRes.json();
                if (sData.episodes) sData.episodes.forEach(ep => {
                    const row = document.createElement('tr');
                    let savedLink = '';
                    if (existingData && existingData.episodes) {
                        const saved = existingData.episodes.find(e => parseInt(e.season) === ep.season_number && parseInt(e.episode) === ep.episode_number);
                        if (saved) savedLink = saved.link;
                    }
                    row.innerHTML = `<td>${ep.episode_number}</td><td><strong>${ep.name}</strong></td><td><input type="text" class="video-link" value="${savedLink}" data-season="${ep.season_number}" data-episode="${ep.episode_number}" data-title="${ep.name}" data-thumb="${ep.still_path ? 'https://image.tmdb.org/t/p/w200'+ep.still_path : ''}"></td>`;
                    episodesBody.appendChild(row);
                });
            }
        } catch (e) { alert(e.message); }
    }

    async function loadSeriesForEditing(id) {
        try {
            const record = await pb.collection('media').getOne(id);
            document.getElementById('recordId').value = record.id;
            
            const setCheck = (name, vals) => { if(vals) vals.forEach(v => { const cb = document.querySelector(`input[name="${name}"][value="${v}"]`); if(cb) cb.checked=true; }) };
            setCheck('vjs', record.vjs);
            setCheck('genres', record.genres);
            setCheck('type', record.type); // ✅ Load Special Categories

            saveBtn.textContent = "Update Series";
            if (!record.tmdbId) { alert("Missing TMDB ID, please re-add."); return; }
            await loadTmdbDetails(record.tmdbId, record);
        } catch (e) { alert(e.message); }
    }

    document.getElementById('seriesForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        saveBtn.disabled = true; saveBtn.innerText = "Saving...";
        const getChecked = (name) => Array.from(document.querySelectorAll(`input[name="${name}"]:checked`)).map(cb => cb.value);
        
        const episodes = [];
        document.querySelectorAll('.video-link').forEach(inp => {
            if (inp.value.trim()) episodes.push({ season: parseInt(inp.dataset.season), episode: parseInt(inp.dataset.episode), title: inp.dataset.title, thumbnail: inp.dataset.thumb, link: inp.value.trim() });
        });

        if (!episodes.length) { alert("Add at least one link."); saveBtn.disabled=false; return; }

        const data = {
            title: document.getElementById('seriesTitle').textContent,
            tmdbId: document.getElementById('tmdbId').value,
            description: document.getElementById('seriesOverview').textContent,
            poster: document.getElementById('posterUrl').value,
            backdrop: document.getElementById('backdropUrl').value,
            releaseDate: document.getElementById('firstAirDate').value,
            vjs: getChecked('vjs'),
            genres: getChecked('genres'),
            type: getChecked('type'), // ✅ Save Special Categories
            episodes: episodes,
            contentType: 'tv'
        };

        try {
            const id = document.getElementById('recordId').value;
            if (id) await pb.collection('media').update(id, data);
            else await pb.collection('media').create(data);
            msgEl.textContent = "Success!"; msgEl.style.display = 'block';
            setTimeout(() => window.location.href='all-content.html', 1500);
        } catch (e) { msgEl.textContent = e.message; msgEl.style.display = 'block'; saveBtn.disabled = false; }
    });
</script>
</body>
</html>