<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- Mobile Critical -->
    <title>Manage Series - Admin Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/pocketbase@latest/dist/pocketbase.umd.js"></script>
    <style>
        :root {
            --primary-bg: #0A0F2A; --card-bg: #1C2141; --accent-color: #DFFF00;
            --text-primary: #FFFFFF; --text-secondary: #a9a9b3; --input-bg: #0E1225;
            --success-color: #27ae60; --danger-color: #e74c3c;
            --border-color: #33395b;
        }
        body { background-color: var(--primary-bg); color: var(--text-primary); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; display: flex; min-height: 100vh; }
        
        #mainMenu { width: 250px; flex-shrink: 0; background-color: #111533; padding-top: 20px; border-right: 1px solid var(--border-color); }
        #mainMenu a { display: block; padding: 15px 20px; color: var(--text-secondary); text-decoration: none; display: flex; align-items: center; gap: 10px; }
        #mainMenu a:hover, #mainMenu a.active { background-color: var(--card-bg); color: var(--accent-color); border-left: 4px solid var(--accent-color); }
        
        .main-content { flex-grow: 1; padding: 2rem; overflow-y: auto; width: 100%; box-sizing: border-box; }
        
        #searchView, #detailsView { background-color: var(--card-bg); padding: 2rem; border-radius: 12px; max-width: 1000px; margin: 0 auto; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        
        h2 { color: var(--accent-color); margin-top: 0; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 20px; }
        
        .form-group { margin-bottom: 1.5rem; }
        label { display: block; margin-bottom: 8px; color: var(--text-secondary); font-weight: 500; font-size: 0.9rem; }
        input[type="text"], textarea { width: 100%; background-color: var(--input-bg); border: 1px solid var(--border-color); color: white; padding: 12px; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        
        .btn { padding: 14px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; color: white; margin-top: 10px; width: 100%; }
        .btn-primary { background: linear-gradient(90deg, #FF416C, #FFDE00); color: #000; }
        .btn-secondary { background: var(--input-bg); border: 1px solid var(--border-color); }

        #episodesJsonInput {
            width: 100%; height: 300px; background-color: #000; color: #00ff00;
            border: 1px solid var(--border-color); border-radius: 8px; padding: 15px;
            font-family: 'Courier New', Courier, monospace; font-size: 0.85rem;
            box-sizing: border-box; resize: vertical;
        }

        .checkbox-group { display: flex; flex-wrap: wrap; gap: 8px; background: var(--input-bg); padding: 10px; border-radius: 8px; max-height: 150px; overflow-y: auto; border: 1px solid var(--border-color); }
        .checkbox-label { background: #1a2035; padding: 6px 12px; border-radius: 50px; border: 1px solid var(--border-color); cursor: pointer; display: flex; align-items: center; gap: 5px; font-size: 0.85rem; }
        .checkbox-label:hover { border-color: var(--accent-color); }
        .checkbox-label:has(input:checked) { background-color: rgba(223, 255, 0, 0.15); border-color: var(--accent-color); color: var(--accent-color); }

        .message { padding: 15px; border-radius: 8px; margin-top: 1rem; display: none; text-align: center; font-weight: bold; }
        .message.success { background-color: rgba(39, 174, 96, 0.2); color: var(--success-color); }
        .message.error { background-color: rgba(231, 76, 60, 0.2); color: var(--danger-color); }

        #searchResultsContainer { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; margin-top: 20px; }
        .series-card { background: var(--input-bg); border-radius: 8px; cursor: pointer; overflow: hidden; border: 1px solid var(--border-color); text-align: center; }
        .series-card img { width: 100%; aspect-ratio: 2/3; object-fit: cover; }
        .series-card h3 { padding: 10px; font-size: 0.85rem; margin: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        details { background: #111533; border-radius: 8px; padding: 10px; margin-bottom: 1rem; border: 1px solid var(--border-color); }
        summary { cursor: pointer; font-weight: bold; color: var(--accent-color); }
        pre { background: #000; padding: 10px; border-radius: 4px; white-space: pre-wrap; word-break: break-all; color: #eee; font-size: 0.8rem; }

        /* --- ðŸ“± MOBILE RESPONSIVENESS --- */
        @media (max-width: 768px) {
            body { flex-direction: column; }
            #mainMenu { width: 100%; height: auto; padding: 10px 0; overflow-x: auto; white-space: nowrap; display: flex; border-right: none; border-bottom: 1px solid var(--border-color); }
            #mainMenu a { display: inline-flex; padding: 10px 15px; font-size: 0.9rem; flex-direction: column; gap: 5px; text-align: center; min-width: 60px; }
            #mainMenu i { font-size: 1.2rem; margin-bottom: 2px; }
            
            .main-content { padding: 1rem; }
            #searchView, #detailsView { padding: 1.2rem; }
            
            #seriesHeader { flex-direction: column !important; align-items: center; text-align: center; }
            #seriesPoster { width: 140px !important; margin-bottom: 15px; }
            
            #searchResultsContainer { grid-template-columns: repeat(2, 1fr); }
            
            .btn-group { flex-direction: column-reverse; } /* Stack buttons */
        }
    </style>
</head>
<body>

   <nav id="mainMenu">
        <a href="index.html"><i class="fas fa-tachometer-alt"></i> <span>Dashboard</span></a>
        <a href="manage-movies.html"><i class="fas fa-film"></i> <span>Movies</span></a>
        <a href="manage-series.html" class="active"><i class="fas fa-tv"></i> <span>Series</span></a>
        <a href="manage-banners.html"><i class="fas fa-images"></i> <span>Banners</span></a>
        <a href="manage-notifications.html"><i class="fas fa-paper-plane"></i> <span>Notify</span></a>
        <a href="manage-users.html"><i class="fas fa-users-cog"></i> <span>Users</span></a>
        <a href="all-content.html"><i class="fas fa-list-ul"></i> <span>All</span></a>
    </nav>

    <div class="main-content">
        
        <div id="searchView">
            <h2>Search TMDB for Series</h2>
            <div class="form-group">
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="seriesSearchQuery" placeholder="e.g., The Last of Us">
                    <button id="searchTmdbBtn" class="btn btn-secondary" style="width: auto; margin-top:0;">Search</button>
                </div>
            </div>
            <div id="searchResultsContainer"></div>
        </div>

        <div id="detailsView" style="display: none;">
            <div id="seriesHeader" style="display: flex; gap: 20px; margin-bottom: 20px;">
                <img id="seriesPoster" src="" style="width: 120px; border-radius: 8px;">
                <div>
                    <h2 id="seriesTitle">Title</h2>
                    <p id="seriesOverview" style="font-size: 0.9rem; color: #ccc; line-height: 1.4;"></p>
                </div>
            </div>

            <form id="seriesForm">
                <input type="hidden" id="recordId">
                <input type="hidden" id="tmdb_id">
                <input type="hidden" id="posterUrl">
                <input type="hidden" id="backdropUrl">
                <input type="hidden" id="releaseYear">
                <input type="hidden" id="cleanTitle">

                <div class="form-group">
                    <label>VJ Name</label>
                    <div id="vjContainer" class="checkbox-group"></div>
                </div>

                <!-- SEPARATED GENRES -->
                <div class="form-group">
                    <label>Genres <small>(TMDB)</small></label>
                    <div id="genresContainer" class="checkbox-group"></div>
                </div>

                <!-- SEPARATED TAGS -->
                <div class="form-group">
                    <label>App Tags <small>(Sections)</small></label>
                    <div id="tagsContainer" class="checkbox-group"></div>
                </div>

                <div class="form-group">
                    <label for="episodesJsonInput">Episodes JSON (Season/Ep/URL)</label>
                    <details>
                        <summary>Click for JSON Example</summary>
                        <pre id="jsonExample"></pre>
                    </details>
                    <textarea id="episodesJsonInput" placeholder="Fetching episodes..."></textarea>
                </div>

                <div class="btn-group" style="display: flex; gap: 15px; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="window.location.href='all-content.html'">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="saveBtn">Save Series</button>
                </div>
            </form>
            <div id="formMessage" class="message" style="display: none;"></div>
        </div>

    </div>
<script>
    const pb = new PocketBase('https://db.streamzonemovies.online');
    pb.autoCancellation(false);
    const TMDB_API_KEY = "f7a3b097ba7a990fd0c8ef3147646fb5";

    const VJ_LIST = ["VJ JUNIOR", "VJ TONNY", "VJ PAX", "VJ EMMY", "VJ LIGHT","VJ RYAN","VJ JOE", "HEAVY Q", "VJ MK","VJ HAM", "VJ MARK", "VJ SHIELD", "VJ ISMA K","VJ MOSCO", "ILLESS", "VJ BONNY", "VJ NEIL", "VJ JOVAN", "VJ TOM", "VJ SHAO K", "VJ JINGO", "VJ ICE P", "VJ KEVO", "VJ KEVIN", "VJ KIN", "VJ KRISS SWEET", "VJ HD", "VJ DAN DE", "VJ SAMMY", "VJ IVO", "VJ LITTLE T", "VJ LASH", "VJ MOX", "VJ MUBA", "VJ EDDY", "VJ KAM", "VJ LANCE", "VJ KS", "VJ ULIO", "VJ AARON", "VJ CABS", "VJ BANKS", "VJ JIMMY", "VJ BAROS", "VJ SOUL", "VJ SON", "VJ KIMULI", "VJ FREDY", "VJ JUMPERS", "VJ ASHIM", "VJ PAULETA", "VJ MARTIN K", "VJ HENRICO", "VJ MUSA", "VJ UNCLE T", "VJ WAZA", "VJ RONAGE"];
    
    // âœ… SEPARATE LISTS
    const GENRE_LIST = [
        "ACTION", "ADVENTURE", "ANIMATION", "COMEDY", "CRIME", "DOCUMENTARY", "DRAMA", 
        "FAMILY", "FANTASY", "HISTORY", "HORROR", "KUNGU FU", "LOVE STORY", "MUSIC", 
        "MYSTERY", "ROMANCE", "SCI FI", "SPORT", "THRILLER", "WAR", "WESTERN"
    ];
    
    const TAGS_LIST = [
        "latest_uploads","Latest-TV-Series", "recent_tv_shows", "western_series", 
        "k_dramas", "indian", "most_liked", "upcoming_shows", "high-school"
    ];

    const searchView = document.getElementById('searchView');
    const detailsView = document.getElementById('detailsView');
    const searchResults = document.getElementById('searchResultsContainer');
    const msgEl = document.getElementById('formMessage');
    const saveBtn = document.getElementById('saveBtn');
    const episodesJsonInput = document.getElementById('episodesJsonInput');

    document.addEventListener('DOMContentLoaded', () => {
        createCheckboxes(VJ_LIST, 'vjContainer', 'vjs');
        // âœ… Create Separate Checkboxes
        createCheckboxes(GENRE_LIST, 'genresContainer', 'genres');
        createCheckboxes(TAGS_LIST, 'tagsContainer', 'tags');

        const example = [{ season: 1, episode: 1, title: "Episode Title", url: "YOUR_VIDEO_URL_HERE" }];
        document.getElementById('jsonExample').textContent = JSON.stringify(example, null, 2);

        const urlParams = new URLSearchParams(window.location.search);
        const editId = urlParams.get('id');
        if (editId) loadSeriesForEditing(editId);
    });

    function createCheckboxes(list, containerId, name) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        list.sort().forEach(item => {
            const label = document.createElement('label');
            label.className = 'checkbox-label';
            const displayText = item.replace(/_/g, ' ').replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            label.innerHTML = `<input type="checkbox" name="${name}" value="${item}"> ${displayText}`;
            container.appendChild(label);
        });
    }

    document.getElementById('searchTmdbBtn').addEventListener('click', async () => {
        const query = document.getElementById('seriesSearchQuery').value;
        if (!query) return;
        searchResults.innerHTML = '<p>Searching...</p>';
        try {
            const res = await fetch(`https://api.themoviedb.org/3/search/tv?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(query)}`);
            const data = await res.json();
            searchResults.innerHTML = '';
            if (!data.results?.length) { searchResults.innerHTML = '<p>No results found.</p>'; return; }
            data.results.forEach(series => {
                const card = document.createElement('div');
                card.className = 'series-card';
                const year = series.first_air_date ? series.first_air_date.split('-')[0] : '';
                card.innerHTML = `<img src="${series.poster_path ? 'https://image.tmdb.org/t/p/w200'+series.poster_path : 'https://placehold.co/200'}" ><h3>${series.name} (${year})</h3>`;
                card.addEventListener('click', () => loadTmdbDetails(series.id));
                searchResults.appendChild(card);
            });
        } catch (e) { alert(e.message); }
    });

    async function loadTmdbDetails(tmdbId, existingRecord = null) {
        searchView.style.display = 'none'; detailsView.style.display = 'block';
        episodesJsonInput.value = 'Fetching episodes from TMDB...';

        try {
            const res = await fetch(`https://api.themoviedb.org/3/tv/${tmdbId}?api_key=${TMDB_API_KEY}`);
            const data = await res.json();

            let cleanYear = "";
            if (data.first_air_date) cleanYear = data.first_air_date.split('-')[0];
            document.getElementById('releaseYear').value = cleanYear;
            document.getElementById('cleanTitle').value = data.name; 
            document.getElementById('seriesTitle').textContent = data.name + (cleanYear ? ` (${cleanYear})` : "");

            document.getElementById('seriesOverview').textContent = data.overview;
            document.getElementById('seriesPoster').src = data.poster_path ? `https://image.tmdb.org/t/p/w500${data.poster_path}` : '';
            document.getElementById('tmdb_id').value = String(data.id);
            document.getElementById('posterUrl').value = data.poster_path ? `https://image.tmdb.org/t/p/w500${data.poster_path}` : '';
            document.getElementById('backdropUrl').value = data.backdrop_path ? `https://image.tmdb.org/t/p/original${data.backdrop_path}` : '';

            // âœ… RESET & SELECT GENRES
            document.querySelectorAll('input[name="genres"]').forEach(cb => cb.checked = false);
            document.querySelectorAll('input[name="tags"]').forEach(cb => cb.checked = false);

            if (data.genres && !existingRecord) {
                data.genres.forEach(g => {
                    const tmdbGenre = g.name.toUpperCase();
                    const mappedGenre = tmdbGenre === 'SCI-FI & FANTASY' ? 'SCI FI' : tmdbGenre;
                    if(GENRE_LIST.includes(mappedGenre)) {
                        document.querySelector(`input[name="genres"][value="${mappedGenre}"]`).checked = true;
                    }
                });
            }

            const episodePromises = data.seasons
                .filter(s => s.season_number > 0 && s.episode_count > 0)
                .map(s => fetch(`https://api.themoviedb.org/3/tv/${tmdbId}/season/${s.season_number}?api_key=${TMDB_API_KEY}`).then(res => res.json()));
            
            const seasonsData = await Promise.all(episodePromises);
            
            let episodesForJson = [];
            seasonsData.forEach(seasonData => {
                seasonData.episodes.forEach(ep => {
                    let video_url = "";
                    if (existingRecord && existingRecord.episodes) {
                        const savedEp = existingRecord.episodes.find(e => e.season === ep.season_number && e.episode === ep.episode_number);
                        if (savedEp) video_url = savedEp.url || ""; 
                    }
                    episodesForJson.push({
                        season: ep.season_number,
                        episode: ep.episode_number,
                        title: ep.name || `Episode ${ep.episode_number}`,
                        url: video_url 
                    });
                });
            });
            episodesJsonInput.value = JSON.stringify(episodesForJson, null, 2);
        } catch (e) { 
            alert(`Error fetching data from TMDB: ${e.message}`);
            episodesJsonInput.value = `// Error loading episodes.`;
        }
    }
    
    async function loadSeriesForEditing(id) {
        try {
            const record = await pb.collection('media').getOne(id);
            document.getElementById('recordId').value = record.id;
            saveBtn.textContent = "Update Series";

            document.getElementById('cleanTitle').value = record.title; 
            document.getElementById('seriesTitle').textContent = record.title; 
            document.getElementById('releaseYear').value = record.year || '';

            const setCheck = (name, vals) => { if(vals) vals.forEach(v => { const cb = document.querySelector(`input[name="${name}"][value="${v}"]`); if(cb) cb.checked=true; }) };
            setCheck('vjs', record.vjs);
            // âœ… Load separately
            setCheck('genres', record.genres);
            setCheck('tags', record.tags);

            if (record.tmdb_id) {
                await loadTmdbDetails(record.tmdb_id, record);
            } else {
                searchView.style.display = 'none'; detailsView.style.display = 'block';
                document.getElementById('seriesTitle').textContent = record.title;
                document.getElementById('seriesOverview').textContent = record.description;
                document.getElementById('seriesPoster').src = record.poster || '';
                episodesJsonInput.value = JSON.stringify(record.episodes || [], null, 2);
            }
        } catch (e) { alert(`Error loading series from database: ${e.message}`); }
    }

    document.getElementById('seriesForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        saveBtn.disabled = true; saveBtn.innerText = "Saving...";
        msgEl.style.display = 'none';

        let episodes;
        try {
            episodes = JSON.parse(episodesJsonInput.value);
            if (!Array.isArray(episodes)) throw new Error("JSON data must be an array.");
        } catch (err) {
            msgEl.textContent = `Invalid Episodes JSON: ${err.message}`;
            msgEl.className = "message error";
            msgEl.style.display = 'block';
            saveBtn.disabled = false; saveBtn.innerText = "Save Series";
            return;
        }
        
        const getChecked = (name) => Array.from(document.querySelectorAll(`input[name="${name}"]:checked`)).map(cb => cb.value);

        const data = {
            title: document.getElementById('cleanTitle').value,
            tmdb_id: document.getElementById('tmdb_id').value,
            description: document.getElementById('seriesOverview').textContent,
            poster: document.getElementById('posterUrl').value,
            backdrop: document.getElementById('backdropUrl').value,
            year: document.getElementById('releaseYear').value, 
            vjs: getChecked('vjs'),
            // âœ… Save separately
            genres: getChecked('genres'),
            tags: getChecked('tags'),
            episodes: episodes,
            contentType: 'tv'
        };

        try {
            const id = document.getElementById('recordId').value;
            if (id) {
                await pb.collection('media').update(id, data);
            } else {
                await pb.collection('media').create(data);
            }
            msgEl.textContent = "Series saved successfully!";
            msgEl.className = "message success";
            msgEl.style.display = 'block';
            setTimeout(() => window.location.href='all-content.html', 1500);
        } catch (err) {
            msgEl.textContent = `Error: ${err.message}`;
            msgEl.className = "message error";
            msgEl.style.display = 'block';
            saveBtn.disabled = false;
            saveBtn.innerText = document.getElementById('recordId').value ? "Update Series" : "Save Series";
        }
    });
</script>
</body>
</html>