<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Movies - Admin Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- PocketBase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/pocketbase@latest/dist/pocketbase.umd.js"></script>
    <style>
        :root {
            --primary-bg: #0A0F2A; --card-bg: #1C2141; --accent-color: #DFFF00;
            --text-primary: #FFFFFF; --text-secondary: #a9a9b3; --logout-bg: #e74c3c;
            --input-bg: #0A0F2A; --success-color: #4CAF50; --danger-color: #f44336;
        }
        body { background-color: var(--primary-bg); color: var(--text-primary); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; margin: 0; }
        #adminPanel { display: flex; min-height: 100vh; }
        #mainMenu { width: 250px; flex-shrink: 0; background-color: #111533; transition: transform 0.3s ease; z-index: 1000; }
        #mainMenu a { display: block; padding: 15px 20px; color: var(--text-secondary); text-decoration: none; transition: background-color 0.3s, color 0.3s; }
        #mainMenu a:hover, #mainMenu a.active { background-color: var(--card-bg); color: var(--accent-color); }
        #mainMenu .menu-header { padding: 20px; font-size: 1.2rem; font-weight: 600; color: var(--text-primary); }
        #mainMenu a i { margin-right: 10px; }
        .main-content { flex-grow: 1; padding: 1.5rem; }
        .admin-header { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: flex-start; gap: 15px; margin-bottom: 10px; }
        .admin-header h1 { color: var(--accent-color); font-size: 2.5rem; font-weight: 700; line-height: 1.1; margin: 0; }
        .user-info { color: var(--text-secondary); font-size: 0.9rem; margin-top: 10px; }
        #menuToggleBtn { display: none; background: transparent; color: var(--accent-color); border: 2px solid var(--accent-color); border-radius: 8px; width: 50px; height: 50px; font-size: 1.5rem; cursor: pointer; padding: 0; margin-right: 20px; }
        .logout-btn { background-color: var(--logout-bg); color: white; border: none; border-radius: 8px; padding: 12px 20px; font-size: 1rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; }
        #searchView, #detailsView { background-color: var(--card-bg); padding: 2rem; border-radius: 15px; margin-top: 2rem; }
        #searchView h2, #detailsView h2 { font-size: 1.2rem; color: var(--text-primary); margin: 0 0 1rem 0; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 5px; color: var(--text-secondary); }
        .form-group input[type="text"], .form-group input[type="url"] { width: 100%; background-color: var(--input-bg); border: 1px solid #33395b; border-radius: 8px; padding: 15px; color: var(--text-primary); font-size: 1rem; box-sizing: border-box; }
        #searchTmdbBtn, #submitBtn { width: 100%; background: linear-gradient(90deg, #FF416C, #FFDE00); color: #0A0F2A; border: none; border-radius: 8px; padding: 15px; font-size: 1.1rem; font-weight: 700; cursor: pointer; margin-top: 1.5rem; transition: transform 0.2s ease; }
        #searchTmdbBtn:hover, #submitBtn:hover { transform: scale(1.02); }
        #detailsHeader { display: flex; gap: 20px; margin-bottom: 1.5rem; align-items: flex-start; }
        #moviePoster { border-radius: 8px; width: 150px; }
        .checkbox-group { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 10px; max-height: 150px; overflow-y: auto; background-color: var(--input-bg); padding: 10px; border-radius: 8px; }
        .checkbox-group label { display: flex; align-items: center; gap: 5px; cursor: pointer; }
        .message { padding: 15px; border-radius: 8px; margin-top: 1rem; display: none; }
        .message.success { background-color: var(--success-color); } .message.error { background-color: var(--danger-color); } .message.info { background-color: var(--info-color); }
        @media (max-width: 768px) {
            #adminPanel { flex-direction: column; } .admin-header h1 { font-size: 2rem; } #menuToggleBtn { display: block; }
            #mainMenu { position: fixed; left: 0; top: 0; height: 100%; transform: translateX(-100%); }
            #mainMenu.open { transform: translateX(0); }
        }
    </style>
</head>
<body>
    <div id="adminPanel">
        <nav id="mainMenu">
            <div class="menu-header">Admin Menu</div>
            <a href="index.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
            <hr style="border-color: #333; margin: 10px 0;">
            <a href="manage-movies.html" class="active"><i class="fas fa-film"></i> Manage Movies</a>
            <a href="manage-series.html"><i class="fas fa-tv"></i> Manage Series</a>
            <a href="manage-banners.html"><i class="fas fa-images"></i> Manage Banners</a>
            <a href="manage-notifications.html"><i class="fas fa-paper-plane"></i> Notifications</a>
            <a href="manage-users.html"><i class="fas fa-users-cog"></i> User Management</a>
        </nav>
        <div class="main-content">
            <div class="admin-header">
                <div style="display: flex; align-items: center;">
                    <button id="menuToggleBtn"><i class="fas fa-bars"></i></button>
                    <h1>Manage Movies</h1>
                </div>
                <button class="logout-btn" id="logoutBtn">Logout <i class="fas fa-sign-out-alt"></i></button>
            </div>
            <p class="user-info" id="adminEmailDisplay">Logged in as...</p>
            <div class="page-container">
                <div id="searchView">
                    <h2>Add a New Movie</h2>
                    <div class="form-group"><label for="searchQuery">Search for a movie by title</label><input type="text" id="searchQuery" placeholder="e.g., The Matrix"></div>
                    <button id="searchTmdbBtn">Search on TMDB</button>
                    <div id="searchResultsContainer"></div>
                </div>
                <div id="detailsView" style="display: none;">
                    <div id="detailsHeader">
                        <img id="moviePoster" src="" alt="Movie Poster">
                        <div><h2 id="movieTitle"></h2><p id="movieOverview"></p></div>
                    </div>
                    <div class="form-group"><label for="vjs">Select VJ(s)</label><div class="checkbox-group" id="vjsCheckboxes"></div></div>
                    <div class="form-group"><label for="stream_link">Video Source URL (Required)</label><input type="url" id="stream_link" required></div>
                    <div class="form-group"><label>Select Tags/Categories</label><div class="checkbox-group" id="tagsCheckboxes"></div></div>
                    <div class="form-group"><label>Genres (from TMDB)</label><div class="checkbox-group" id="genresCheckboxes"></div></div>
                    <div style="display: flex; gap: 15px; margin-top: 20px;">
                        <button id="submitBtn" style="flex: 1;">Create Movie</button>
                        <button id="cancelBtn" style="flex: 1; background: #555;">Cancel</button>
                    </div>
                </div>
                <div id="formMessage" class="message"></div>
            </div>
        </div>
    </div>

<!-- =============================================================================== -->
<!-- ENTIRE SCRIPT IS REPLACED WITH POCKETBASE LOGIC -->
<!-- =============================================================================== -->
<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- Initialize PocketBase Connection ---
    const pb = new PocketBase('http://38.19.200.33');

    // --- TMDB API Configuration ---
    const TMDB_API_KEY = "f7a3b097ba7a990fd0c8ef3147646fb5";
    let currentMovieData = null;
    let editModeRecordId = null;

    // --- DOM Elements ---
    const adminPanel = document.getElementById('adminPanel');
    const logoutBtn = document.getElementById('logoutBtn');
    const adminEmailDisplay = document.getElementById('adminEmailDisplay');
    const searchView = document.getElementById('searchView');
    const detailsView = document.getElementById('detailsView');
    const searchTmdbBtn = document.getElementById('searchTmdbBtn');
    const searchResultsContainer = document.getElementById('searchResultsContainer');
    const submitBtn = document.getElementById('submitBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const formMessage = document.getElementById('formMessage');
    const menuToggleBtn = document.getElementById('menuToggleBtn');
    const mainMenu = document.getElementById('mainMenu');

    // --- Utility Functions ---
    const setLoading = (btn, isLoading) => { if(btn) { btn.disabled = isLoading; btn.textContent = isLoading ? 'Loading...' : (editModeRecordId ? 'Update Movie' : 'Create Movie'); }};
    const displayMessage = (msg, type) => { formMessage.textContent = msg; formMessage.className = `message ${type}`; formMessage.style.display = 'block'; setTimeout(() => { formMessage.style.display = 'none'; }, 5000); };

    // --- Authentication ---
    // Check if admin is logged in
    if (!pb.authStore.isAdmin) {
        // In a real app, you would redirect to a dedicated login page.
        // For this example, we'll just show an alert and hide the panel.
        alert('Admin authentication required. Please log in via the main admin dashboard.');
        adminPanel.style.display = 'none';
        // You would redirect here: window.location.href = '/admin/login.html';
        return;
    } else {
        adminEmailDisplay.textContent = `Logged in as: ${pb.authStore.model.email}`;
    }

    logoutBtn.addEventListener('click', () => {
        pb.authStore.clear();
        window.location.reload();
    });
    
    if (menuToggleBtn) menuToggleBtn.addEventListener('click', () => mainMenu.classList.toggle('open'));

    // --- Main Logic ---
    async function initializePage() {
        const urlParams = new URLSearchParams(window.location.search);
        const recordId = urlParams.get('id');
        if (recordId) {
            editModeRecordId = recordId;
            await loadMovieForEditing(recordId);
        } else {
            // Populate checkboxes for a new movie
            const collection = await pb.collection('media').getOne(pb.collection('media').getFirstListItem().id); // Hack to get schema
            populateCheckboxes('vjsCheckboxes', collection['@collection'].schema.find(f => f.name === 'vjs').options.values);
            populateCheckboxes('tagsCheckboxes', collection['@collection'].schema.find(f => f.name === 'tags').options.values);
        }
    }

    function populateCheckboxes(containerId, list, selectedValues = []) {
        const container = document.getElementById(containerId);
        if (!container) return;
        container.innerHTML = '';
        list.forEach(item => {
            const labelEl = document.createElement('label');
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.name = containerId;
            checkbox.value = item;
            checkbox.checked = selectedValues.includes(item);
            labelEl.appendChild(checkbox);
            labelEl.appendChild(document.createTextNode(` ${item}`));
            container.appendChild(labelEl);
        });
    }

    searchTmdbBtn.addEventListener('click', async () => {
        const query = document.getElementById('searchQuery').value;
        if (!query) return;
        setLoading(searchTmdbBtn, true);
        searchResultsContainer.innerHTML = '<p class="message info" style="display:block">Searching...</p>';
        try {
            const response = await fetch(`https://api.themoviedb.org/3/search/movie?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(query)}`);
            const data = await response.json();
            displaySearchResults(data.results);
        } catch (error) {
            searchResultsContainer.innerHTML = `<p class="message error" style="display:block">Error: ${error.message}</p>`;
        } finally {
            setLoading(searchTmdbBtn, false);
            searchTmdbBtn.textContent = 'Search on TMDB';
        }
    });

    function displaySearchResults(results) {
        searchResultsContainer.innerHTML = '';
        if (!results || results.length === 0) {
            searchResultsContainer.innerHTML = '<p class="message info" style="display:block">No results found.</p>';
            return;
        }
        results.forEach(movie => {
            const posterPath = movie.poster_path ? `https://image.tmdb.org/t/p/w200${movie.poster_path}` : 'https://placehold.co/100x150?text=N/A';
            searchResultsContainer.innerHTML += `
                <div style="background-color: var(--primary-bg); border-radius: 8px; padding: 1rem; margin-top: 1rem; display: flex; gap: 1rem;">
                    <img src="${posterPath}" alt="${movie.title}" style="width: 100px; border-radius: 4px;">
                    <div style="flex: 1;">
                        <h3>${movie.title} (${movie.release_date ? movie.release_date.split('-')[0] : 'N/A'})</h3>
                        <p style="font-size: 0.9rem; color: var(--text-secondary);">${movie.overview.substring(0, 150)}...</p>
                        <button class="select-btn" data-id="${movie.id}" style="padding: 8px 12px; cursor: pointer; border-radius: 4px; border: none; background-color: var(--accent-color); color: var(--primary-bg); font-weight: bold;">Select</button>
                    </div>
                </div>`;
        });
    }

    searchResultsContainer.addEventListener('click', async e => {
        if (e.target.classList.contains('select-btn')) {
            const movieId = e.target.dataset.id;
            e.target.disabled = true;
            e.target.textContent = 'Loading...';
            await fetchAndDisplayMovieDetails(movieId);
            e.target.disabled = false;
            e.target.textContent = 'Select';
        }
    });

    async function fetchAndDisplayMovieDetails(movieId, existingData = null) {
        displayMessage("Fetching details from TMDB...", "info");
        try {
            const response = await fetch(`https://api.themoviedb.org/3/movie/${movieId}?api_key=${TMDB_API_KEY}`);
            const data = await response.json();
            currentMovieData = data;

            document.getElementById('moviePoster').src = data.poster_path ? `https://image.tmdb.org/t/p/w200${data.poster_path}` : '';
            document.getElementById('movieTitle').textContent = data.title;
            document.getElementById('movieOverview').textContent = data.overview;
            
            const tmdbGenres = data.genres.map(g => g.name);
            populateCheckboxes('genresCheckboxes', tmdbGenres, existingData ? existingData.tags : tmdbGenres);
            
            if (existingData) {
                document.getElementById('stream_link').value = existingData.stream_link || '';
                // The schema is now fetched on init, but we re-populate with existing data
                populateCheckboxes('vjsCheckboxes', (await pb.collection('media').getOne(existingData.id))['@collection'].schema.find(f => f.name === 'vjs').options.values, existingData.vjs);
                populateCheckboxes('tagsCheckboxes', (await pb.collection('media').getOne(existingData.id))['@collection'].schema.find(f => f.name === 'tags').options.values, existingData.tags);
            }

            searchView.style.display = 'none';
            detailsView.style.display = 'block';
            window.scrollTo(0, 0);
        } catch (error) {
            displayMessage(`Error fetching details: ${error.message}`, 'error');
        }
    }

    async function loadMovieForEditing(recordId) {
        displayMessage("Loading existing movie data...", "info");
        searchView.style.display = 'none';
        detailsView.style.display = 'block';
        submitBtn.textContent = 'Update Movie';
        try {
            const movieData = await pb.collection('media').getOne(recordId);
            if (!movieData.tmdb_id) throw new Error("Movie is missing TMDB ID and cannot be edited this way.");
            await fetchAndDisplayMovieDetails(movieData.tmdb_id, movieData);
        } catch(error) {
            displayMessage(`Error loading data for editing: ${error.message}`, 'error');
            detailsView.style.display = 'none';
        }
    }

    submitBtn.addEventListener('click', async () => {
        setLoading(submitBtn, true);
        const selectedVjs = Array.from(document.querySelectorAll('#vjsCheckboxes input:checked')).map(cb => cb.value);
        if (selectedVjs.length === 0) {
            displayMessage('At least one VJ must be selected.', 'error');
            setLoading(submitBtn, false);
            return;
        }

        try {
            const data = {
                "title": currentMovieData.title,
                "description": currentMovieData.overview,
                "poster": currentMovieData.poster_path ? `https://image.tmdb.org/t/p/w500${currentMovieData.poster_path}` : '',
                "backdrop": currentMovieData.backdrop_path ? `https://image.tmdb.org/t/p/original${currentMovieData.backdrop_path}` : '',
                "stream_link": document.getElementById('stream_link').value,
                "vjs": selectedVjs,
                "contentType": "movie",
                "tags": Array.from(document.querySelectorAll('#tagsCheckboxes input:checked, #genresCheckboxes input:checked')).map(cb => cb.value),
                "tmdb_id": currentMovieData.id
            };

            if (editModeRecordId) {
                await pb.collection('media').update(editModeRecordId, data);
            } else {
                await pb.collection('media').create(data);
            }
            
            displayMessage(`Movie successfully ${editModeRecordId ? 'updated' : 'created'}!`, 'success');
            setTimeout(() => { window.location.href = 'index.html'; }, 2000);

        } catch (error) {
            displayMessage(`Operation failed: ${error.response?.message || error.message}`, 'error');
        } finally {
            setLoading(submitBtn, false);
        }
    });
    
    cancelBtn.addEventListener('click', () => {
        if(confirm('Are you sure? Any unsaved changes will be lost.')){
            window.location.href = 'index.html';
        }
    });

    // --- Initialize the page ---
    initializePage();
});
</script>
</body>
</html>